<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Bijak Sifir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Muatkan font 'Inter' */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Gaya Font Standard untuk Jenama */
        .brand-marykate {
            font-family: 'Inter', sans-serif; 
            color: #ec4899; /* Pink 500 */
            font-size: 0.875rem; /* Saiz dikurangkan ke text-sm */
            line-height: 1.5rem;
            font-weight: 900; /* Extra Black */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .result-score {
            /* Warna bayangan diselaraskan dengan warna Merah Jambu (Pink) */
            animation: pulse-score 1.5s infinite;
        }
        @keyframes pulse-score {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(236, 72, 153, 0.7); /* Pink 500 Shadow */ }
            100% { transform: scale(1); }
        }
        /* Style untuk pemasa soalan yang mendesak (10s terakhir) */
        .urgent-timer {
            color: #fff; /* Teks putih */
            background-color: #ef4444; /* Red 500 */
            border-color: #fca5a5; /* Red 300 */
            animation: urgent-pulse 0.5s infinite;
        }
        @keyframes urgent-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* --- Gaya Sijil Cetak (Penting untuk Save as PDF) --- */
        @media print {
            .no-print {
                display: none !important;
            }
            #quiz-container-wrapper {
                display: none !important;
            }
            #certificate-screen {
                display: flex !important;
                position: absolute; 
                top: 0;
                left: 0;
                width: 100%;
                height: auto; 
                overflow: hidden !important; 
                background-color: white;
            }
            .certificate-container {
                width: 100%;
                max-width: none;
                height: auto; 
                margin: 0;
                padding: 1cm;
                box-shadow: none;
                border: none;
            }
        }
        /* --- Akhir Gaya Sijil Cetak --- */

        /* Benarkan scrolling pada skrin sijil jika kandungan panjang */
        #certificate-screen {
            overflow-y: auto; 
        }

    </style>
</head>
<body class="bg-yellow-50 min-h-screen flex items-center justify-center p-4">

    <div id="quiz-container-wrapper" class="w-full max-w-md bg-white p-6 rounded-xl shadow-xl border-3 border-pink-300">
        <h1 class="text-2xl font-extrabold text-teal-600 text-center mb-1">
            Kuiz Bijak Sifir
        </h1>
        
        <p class="brand-marykate text-center mb-5 mt-1">
            -- Edukids by Mizz --
        </p>

        <div id="quiz-container">
            
            <div id="login-screen" class="space-y-4">
                <p class="text-gray-600 text-center text-sm font-semibold">
                    Akses terhad. Sila masukkan Kata Laluan untuk meneruskan.
                </p>

                <div class="space-y-2">
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Kata Laluan:</label>
                    <input type="text" id="password-input" placeholder="Masukkan Kata Laluan" class="w-full p-3 text-center text-lg font-bold border-3 border-pink-400 rounded-lg focus:border-teal-500 focus:ring-4 focus:ring-teal-200" onkeydown="handleLoginKey(event)" autofocus>
                    <p id="login-feedback" class="h-6 text-sm font-semibold text-red-600 text-center"></p>
                </div>

                <button onclick="checkPassword()" id="login-button" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                    Log Masuk
                </button>
               <p class="text-xs text-gray-500 text-center mt-3">
    Lupa atau Tiada Kata Laluan?
    <a href="https://wa.me/60198950339?text=Assalamualaikum.%20Saya%20memohon%20kata%20laluan%20untuk%20Kuiz%20Bijak%20Sifir.%20Nama%20saya%20[Nama%20Pelajar/Ibu%20Bapa]." target="_blank" class="font-bold text-pink-500 hover:text-pink-600 transition duration-150">
        Minta Kata Laluan (WhatsApp Mizz).
    </a>
</p>
            </div>
            
            <div id="selection-screen" class="hidden space-y-4">
                
                <div class="space-y-2 p-3 bg-teal-50 rounded-lg border border-teal-300">
                    <label for="student-name-input" class="block text-sm font-black text-teal-700">
                        Masukkan Nama Pelajar (Untuk Sijil):
                    </label>
                    <input 
                        type="text" 
                        id="student-name-input" 
                        placeholder="Cth: Ali Bin Abu" 
                        class="w-full p-3 text-center text-base font-bold border-2 border-teal-500 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200" 
                        oninput="updateAndSaveName(event)"
                    >
                    <p id="current-name-display" class="text-xs text-gray-600 italic mt-1 text-center"></p>
                </div>
                <p class="text-gray-600 text-center text-sm">
                    Sila pilih jenis kuiz dan sifir yang ingin diuji (50 soalan).
                </p>

                <div class="p-2 bg-blue-100 border border-blue-400 rounded-lg text-xs text-blue-800 font-medium">
    üîî **Nota Audio:** Kualiti dan jantina suara TTS (Text-to-Speech) mungkin berbeza mengikut jenis telefon/komputer. Suara yang lebih mesra (wanita) akan didapati pada kebanyakan telefon pintar moden.
</div>

                <div class="space-y-2">
                    <label for="sifir-pilihan" class="block text-sm font-medium text-gray-700">Pilih Jenis Ujian:</label>
                    <select id="sifir-pilihan" class="w-full p-3 border-2 border-pink-400 rounded-lg shadow-md focus:ring-teal-500 focus:border-teal-500 bg-white text-teal-700 font-semibold text-sm">
                        <option value="0-objective">üéØ Semua Sifir (1-12) - Objektif A/B/C/D</option>
                        <option value="0-input">‚úçÔ∏è Semua Sifir (1-12) - Input Jawapan</option>
                        <option value="2-input">‚úçÔ∏è Sifir 2 - Input Jawapan</option>
                        <option value="3-input">‚úçÔ∏è Sifir 3 - Input Jawapan</option>
                        <option value="4-input">‚úçÔ∏è Sifir 4 - Input Jawapan</option>
                        <option value="5-input">‚úçÔ∏è Sifir 5 - Input Jawapan</option>
                        <option value="6-input">‚úçÔ∏è Sifir 6 - Input Jawapan</option>
                        <option value="7-input">‚úçÔ∏è Sifir 7 - Input Jawapan</option>
                        <option value="8-input">‚úçÔ∏è Sifir 8 - Input Jawapan</option>
                        <option value="9-input">‚úçÔ∏è Sifir 9 - Input Jawapan</option>
                        <option value="10-input">‚úçÔ∏è Sifir 10 - Input Jawapan</option>
                        <option value="11-input">‚úçÔ∏è Sifir 11 - Input Jawapan</option>
                        <option value="12-input">‚úçÔ∏è Sifir 12 - Input Jawapan</option>
                    </select>
                </div>

                <button onclick="startQuizFlow()" id="start-button" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                    Mulakan Kuiz (50 Soalan)
                </button>
            </div>

            <div id="quiz-screen" class="hidden text-center space-y-4">
                
                <div class="w-full flex justify-between items-center mb-3">
                    <div class="w-3/4 bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="bg-pink-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                    </div>
                    <div id="q-countdown-display" class="text-lg font-black text-teal-600 border-2 border-teal-300 px-3 py-0.5 rounded-full shadow-md transition-colors duration-300">
                        60s
                    </div>
                </div>

                <p class="text-xs text-gray-500">
                    Soalan <span id="current-q-num">1</span> dari 50
                </p>
                <span id="total-time-tracker" class="hidden">0</span>

                <div class="bg-yellow-200 p-6 rounded-xl shadow-lg border-2 border-yellow-500">
                    <p class="text-lg text-gray-500 mb-1">Berapakah</p>
                    <p id="question-text" class="text-4xl font-extrabold text-teal-800">
                        7 x 8 ?
                    </p>
                </div>

                <div id="input-mode" class="space-y-3">
                    <input type="number" id="answer-input" placeholder="Jawab di sini" class="w-full p-3 text-center text-2xl font-bold border-3 border-pink-400 rounded-lg focus:border-teal-500 focus:ring-4 focus:ring-teal-200" onkeydown="handleInputKey(event)" autofocus>

                    <button onclick="handleInputSubmission()" class="w-full bg-lime-500 hover:bg-lime-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                        Hantar Jawapan
                    </button>
                </div>

                <div id="objective-mode" class="hidden grid grid-cols-2 gap-3">
                    <button id="option-A" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        A. <span></span>
                    </button>
                    <button id="option-B" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        B. <span></span>
                    </button>
                    <button id="option-C" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        C. <span></span>
                    </button>
                    <button id="option-D" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        D. <span></span>
                    </button>
                </div>


                <div id="feedback" class="h-6 text-sm font-semibold"></div>

                <button onclick="returnToSelection()" class="w-full bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold text-sm py-2 rounded-lg transition duration-150 shadow-sm mt-4">
                    Kembali ke Pilihan Sifir
                </button>
            </div>

            <div id="result-screen" class="hidden text-center space-y-4">
                <h2 class="text-2xl font-bold text-teal-700">Keputusan Kuiz Anda!</h2>
                
                <p id="main-tp-message" class="text-base font-semibold text-gray-700"></p>

                <div class="p-4 bg-yellow-100 rounded-xl border-3 border-yellow-500">
                    <p class="text-base font-semibold text-gray-700">Tahap Penguasaan (TP) Dicapai:</p>
                    <p id="final-tp" class="text-6xl font-black text-pink-600 result-score mt-1">TPX</p>
                    <p id="tp-label" class="text-xl font-extrabold text-teal-600 mt-1">Label TP</p>
                </div>

                <div class="p-3 bg-pink-100 rounded-lg border border-pink-400 text-left">
                    <p class="text-sm font-bold text-pink-700 mb-1">Penerangan Tahap:</p>
                    <p id="tp-description" class="text-sm text-gray-800 italic">
                        [Penerangan terperinci mengikut DSKP akan dipaparkan di sini.]
                    </p>
                </div>

                <div class="text-left space-y-2 text-sm text-gray-700">
                    <p>‚≠ê Skor Anda: <span id="final-score" class="font-bold text-teal-600"></span></p>
                    <p>üìà Peratusan: <span id="final-percentage" class="font-bold text-teal-600"></span></p>
                    <p>‚úÖ Jawapan Betul: <span id="correct-count" class="font-bold text-lime-600"></span></p>
                    <p>‚ùå Jawapan Salah: <span id="incorrect-count" class="font-bold text-red-600"></span></p>
                    <p>‚è±Ô∏è Purata Masa Tindak Balas: <span id="average-time" class="font-bold"></span> saat</p>
                </div>
                
                <button onclick="displayCertificateForPrint()" id="print-certificate-btn" data-tp="" data-label="" data-score="" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl mt-3">
                    Cetak / Simpan Sijil Pencapaian
                </button>

                <button onclick="startNewQuizSelection()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl mt-3">
                    Ulang Kuiz (Pilihan Sifir)
                </button>
            </div>
        </div>
    </div>
    
    <div id="certificate-screen" class="hidden fixed inset-0 z-50 bg-white items-center justify-center p-4 overflow-y-auto">
        </div>

    <script>
        // Global State Variables
        const QUIZ_DURATION = 250;     
        const QUESTION_DURATION = 60;  
        const CORRECT_PASSWORD = 'KuizSifir5973';
        
        let audioContext = null;
        let currentSifir = 0;
        let currentMode = 'input'; 
        let questions = [];
        let currentQIndex = 0;
        let score = 0;
        let totalTimeElapsed = 0; 
        
        let totalTimeInterval = null; 
        let qTimerInterval = null;    
        let qTimeLeft = QUESTION_DURATION; 
        let warningBeepInterval = null; 
        
        // KEMASKINI: Tambah pembolehubah untuk nama pelajar (Local Storage)
        let studentName = '';
        const STORAGE_KEY_NAME = 'student_name_sifir'; 

        // --- Logik Local Storage ---
        
        // Muatkan nama dari localStorage semasa permulaan
        function loadNameLocally() {
            const storedName = localStorage.getItem(STORAGE_KEY_NAME);
            if (storedName) {
                studentName = storedName;
                document.getElementById('student-name-input').value = studentName;
                document.getElementById('current-name-display').textContent = `Nama yang disimpan: ${studentName}`;
            } else {
                 document.getElementById('current-name-display').textContent = `Nama belum disimpan.`;
            }
        }

        // Kemas kini pembolehubah global dan localStorage apabila input berubah
        function updateAndSaveName(event) {
            const name = event.target.value.trim();
            studentName = name;
            localStorage.setItem(STORAGE_KEY_NAME, name);
            
            if (name) {
                document.getElementById('current-name-display').textContent = `Nama yang disimpan: ${name}`;
            } else {
                 document.getElementById('current-name-display').textContent = `Nama belum disimpan.`;
            }
        }
        
        // Panggil semasa permulaan (sebelum skrin log masuk)
        loadNameLocally(); 
        
        // --- Akhir Logik Local Storage ---


        // Helper function untuk menukar paparan skrin
        function showScreen(screenId) {
            const screens = ['login-screen', 'selection-screen', 'quiz-screen', 'result-screen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Utility: Fisher-Yates shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        // -----------------------------------------------------------------
        // PERUBAHAN UTAMA: FUNGSI TTS DENGAN PENGUTAMAAN SUARA WANITA (ms-MY)
        // -----------------------------------------------------------------
        function speakMalay(textToRead) {
            if (!('speechSynthesis' in window)) {
                console.error("Pelayar tidak menyokong Web Speech API.");
                return;
            }
            window.speechSynthesis.cancel();
            
            try {
                const utterance = new SpeechSynthesisUtterance(textToRead);
                
                // 1. TETAPKAN BAHASA KEPADA BAHASA MELAYU (ms-MY)
                utterance.lang = 'ms-MY';
                utterance.rate = 1.0; 
                utterance.pitch = 1.0; // Boleh cuba 1.1 untuk suara lebih ceria, tetapi biar 1.0 standard

                // 2. CUBA CARI SUARA MELAYU YANG PALING SESUAI (Utamakan Suara Wanita)
                const voices = window.speechSynthesis.getVoices();
                let preferredVoice = null;

                // Cuba cari suara ms-MY yang tidak mempunyai label lelaki/male (Potensi Suara Wanita/Neutral)
                preferredVoice = voices.find(voice => 
                    voice.lang === 'ms-MY' && 
                    !voice.name.toLowerCase().includes('male') && 
                    !voice.name.toLowerCase().includes('lelaki')
                );

                // Jika tiada suara ms-MY yang disukai (bukan lelaki), guna mana-mana suara ms-MY yang ada
                if (!preferredVoice) {
                    preferredVoice = voices.find(voice => voice.lang === 'ms-MY');
                }

                // Jika suara ditemui, gunakannya
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                } else {
                    // Jika suara ms-MY tiada langsung, sistem akan guna suara lalai tetapi dengan tetapan lang="ms-MY"
                    console.warn("Suara Bahasa Melayu (ms-MY) tidak ditemui. Menggunakan suara lalai sistem.");
                }

                // MAIN AUDIO
                window.speechSynthesis.speak(utterance);

            } catch (error) {
                 console.error("Ralat TTS: Audio gagal dimainkan.", error);
            }
        }
        // --- Akhir Logik Native TTS (SpeechSynthesis API) ---

        // --- Logik Web Audio API (Bunyi) ---
        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API tidak boleh dimulakan:", e);
                }
            }
        }
        
        // Nota: initAudio() hanya dipanggil selepas klik pertama. Ini adalah penyelesaian untuk Autoplay.
        document.getElementById('login-button').addEventListener('click', initAudio, { once: true });
        document.getElementById('password-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') initAudio();
        }, { once: true });


        function playTone(frequency, duration, type = 'sine') {
            initAudio();
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = type;
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playCorrectSound() {
            playTone(880, 0.15, 'sine'); 
        }

        function playIncorrectSound() {
            playTone(220, 0.3, 'triangle'); 
        }

        function playWarningBeep() {
            playTone(800, 0.1, 'square');
        }

        function startWarningBeeps() {
            if (warningBeepInterval) return;
            warningBeepInterval = setInterval(() => {
                playWarningBeep();
            }, 500);
        }

        function stopWarningBeeps() {
            if (warningBeepInterval) {
                clearInterval(warningBeepInterval);
                warningBeepInterval = null;
            }
        }
        // --- Akhir Logik Web Audio API ---

        // --- Logik Akses Kata Laluan ---
        function checkPassword() {
            const input = document.getElementById('password-input').value.trim();
            const feedback = document.getElementById('login-feedback');
            
            if (input === CORRECT_PASSWORD) {
                feedback.textContent = 'Log Masuk Berjaya!';
                feedback.classList.remove('text-red-600');
                feedback.classList.add('text-lime-600');
                
                showScreen('selection-screen'); 
                
                // KEMASKINI: Muatkan semula nama pelajar dan fokus pada input nama
                loadNameLocally(); 
                document.getElementById('student-name-input').focus();
                
                // Audio Permulaan di sini (Selepas Log Masuk Berjaya)
                speakMalay('Selamat Datang ke Kuiz Bijak Sifir! Sila masukkan nama anda dan pilih jenis kuiz.');

            } else {
                playIncorrectSound(); 
                feedback.textContent = 'Kata Laluan Salah. Sila cuba lagi.';
                feedback.classList.remove('text-lime-600');
                feedback.classList.add('text-red-600');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }
        function handleLoginKey(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        }
        
        // --- Logik Kuiz ---

        function generateDistractors(correctAnswer) {
            const distractors = new Set();
            const maxAttempts = 10;
            let attempts = 0;
            
            while (distractors.size < 3 && attempts < maxAttempts) {
                attempts++;
                let offset = Math.floor(Math.random() * 11) - 5; 
                let distractor = correctAnswer + offset;

                if (distractor > 0 && distractor !== correctAnswer && !distractors.has(distractor)) {
                    distractors.add(distractor);
                }
            }
            
            if (distractors.size < 3) {
                 [1, -1, 10, correctAnswer % 10 === 0 ? -10 : 0].forEach(offset => {
                    let d = correctAnswer + offset;
                    if (d > 0 && d !== correctAnswer && distractors.size < 3 && !distractors.has(d)) {
                         distractors.add(d);
                    }
                });
            }

            return Array.from(distractors).slice(0, 3);
        }

        function generateQuestions(sifir, mode) {
            questions = [];
            
            for (let i = 0; i < 50; i++) {
                let multiplier;
                let factor = Math.floor(Math.random() * 12) + 1; 

                if (sifir === 0) {
                    multiplier = Math.floor(Math.random() * 12) + 1; 
                } else {
                    multiplier = sifir;
                }

                const correctAnswer = multiplier * factor;
                const qText = `${multiplier} x ${factor}`;
                const newQuestion = { q: qText, answer: correctAnswer, time: 0, answered: false }; 

                if (mode === 'objective') {
                    const distractors = generateDistractors(correctAnswer);
                    let options = [...distractors, correctAnswer];
                    shuffleArray(options); 

                    newQuestion.options = options;
                }

                questions.push(newQuestion);
            }
        }


        function startQuizFlow() {
            // Semak nama pelajar
            if (!studentName.trim()) {
                speakMalay('Sila masukkan nama pelajar terlebih dahulu.');
                document.getElementById('student-name-input').focus();
                // Tunjukkan mesej amaran ringkas di bawah butang start
                const startButton = document.getElementById('start-button');
                startButton.textContent = 'Sila masukkan nama pelajar!';
                startButton.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                startButton.classList.add('bg-red-500', 'hover:bg-red-600');
                setTimeout(() => {
                    startButton.textContent = 'Mulakan Kuiz (50 Soalan)';
                    startButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                    startButton.classList.add('bg-pink-500', 'hover:bg-pink-600');
                }, 1500);
                return;
            }


            const selection = document.getElementById('sifir-pilihan').value.split('-');
            currentSifir = parseInt(selection[0]);
            currentMode = selection[1];

            generateQuestions(currentSifir, currentMode);

            currentQIndex = 0;
            score = 0;
            totalTimeElapsed = 0;
            
            hentikanTimer(); 

            document.getElementById('progress-bar').style.width = `0%`;
            document.getElementById('q-countdown-display').textContent = `${QUESTION_DURATION}s`;

            showScreen('quiz-screen');

            const inputModeEl = document.getElementById('input-mode');
            const objectiveModeEl = document.getElementById('objective-mode');

            if (currentMode === 'input') {
                inputModeEl.classList.remove('hidden');
                objectiveModeEl.classList.add('hidden');
                document.getElementById('answer-input').focus();
            } else { 
                inputModeEl.classList.add('hidden');
                objectiveModeEl.classList.remove('hidden');
                document.getElementById('option-A').focus();
            }

            mulakanTotalTimer();

            // PANGGILAN AUDIO PERMULAAN YANG TELAH DIPERBAIKI
            speakMalay(`Jom mulakan Kuiz Sifir. Anda ada ${QUESTION_DURATION} saat untuk setiap soalan.`);

            paparSoalan();
        }
        
        function returnToSelection() {
            hentikanTimer();
            currentQIndex = 0;
            score = 0;
            totalTimeElapsed = 0;

            speakMalay('Kuiz ditamatkan. Sila buat pilihan baharu.');
            showScreen('selection-screen');
        }

        function startNewQuizSelection() {
            speakMalay('Sila pilih jenis kuiz yang baru.');
            showScreen('selection-screen'); 
        }

        function paparSoalan() {
            hentikanQuestionTimer();

            if (currentQIndex >= 50) {
                tamatkanKuiz();
                return;
            }

            const q = questions[currentQIndex];
            document.getElementById('question-text').textContent = q.q + ' = ?';
            document.getElementById('current-q-num').textContent = currentQIndex + 1;
            document.getElementById('feedback').textContent = '';

            if (currentMode === 'input') {
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
            } else { 
                document.querySelectorAll('.objective-btn').forEach((btn, index) => {
                    const optionValue = q.options[index];
                    btn.classList.remove('bg-pink-600', 'bg-red-600', 'bg-teal-700');
                    btn.classList.add('bg-teal-500', 'hover:bg-teal-600'); 
                    
                    btn.querySelector('span').textContent = optionValue;
                    btn.setAttribute('data-value', optionValue);
                    btn.disabled = false;
                });
            }
            
            mulakanQuestionTimer();
        }
        
        // --- Pengurusan Masa Soalan (60s Countdown) ---

        function mulakanQuestionTimer() {
            qTimeLeft = QUESTION_DURATION;
            const displayEl = document.getElementById('q-countdown-display');
            displayEl.textContent = `${qTimeLeft}s`;
            
            displayEl.classList.remove('urgent-timer');
            stopWarningBeeps();

            qTimerInterval = setInterval(() => {
                qTimeLeft--;
                displayEl.textContent = `${qTimeLeft}s`;

                if (qTimeLeft <= 10 && qTimeLeft > 0) {
                    displayEl.classList.add('urgent-timer');
                    startWarningBeeps();
                } else if (qTimeLeft <= 0) {
                    hentikanQuestionTimer();
                    semakJawapan(null, null, true); 
                } else if (qTimeLeft > 10) {
                    displayEl.classList.remove('urgent-timer');
                    stopWarningBeeps();
                }
            }, 1000); 
        }

        function hentikanQuestionTimer() {
            clearInterval(qTimerInterval);
            stopWarningBeeps();
            qTimerInterval = null;
        }
        
        // --- Pengurusan Masa Keseluruhan (250s Background Timer) ---
        function mulakanTotalTimer() {
            const initialTime = performance.now();
            
            clearInterval(totalTimeInterval);
            
            totalTimeInterval = setInterval(() => {
                const now = performance.now();
                totalTimeElapsed = (now - initialTime) / 1000;
               
                if (totalTimeElapsed >= QUIZ_DURATION) {
                    tamatkanKuiz(true); 
                }
            }, 100); 
        }

        function hentikanTotalTimer() {
            clearInterval(totalTimeInterval);
        }

        function hentikanTimer() {
             hentikanQuestionTimer();
             hentikanTotalTimer();
        }

        function handleInputSubmission() {
            const inputElement = document.getElementById('answer-input');
            const submitButton = document.querySelector('#input-mode button');
            inputElement.disabled = true;
            submitButton.disabled = true;

            const userAnswer = parseInt(inputElement.value.trim());

            if (isNaN(userAnswer)) {
                inputElement.disabled = false;
                submitButton.disabled = false;
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.textContent = 'Sila masukkan nombor yang sah.';
                feedbackEl.className = 'h-6 text-sm font-semibold text-red-600';
                return;
            }
            semakJawapan(userAnswer);
        }

        function handleInputKey(event) {
            if (event.key === 'Enter') {
                const submitButton = document.querySelector('#input-mode button');
                if (!submitButton.disabled) {
                    handleInputSubmission();
                }
            }
        }

        function handleObjectiveSubmission(button) {
            const userAnswer = parseInt(button.getAttribute('data-value'));

            document.querySelectorAll('.objective-btn').forEach(btn => btn.disabled = true);
            
            semakJawapan(userAnswer, button);
        }


        function semakJawapan(userAnswer, selectedButton = null, isTimeout = false) {
            
            hentikanQuestionTimer(); 
            
            const q = questions[currentQIndex];
            
            const timeTaken = isTimeout ? QUESTION_DURATION : (QUESTION_DURATION - qTimeLeft);
            q.time = timeTaken; 
            q.answered = true;

            const feedbackEl = document.getElementById('feedback');
            const correctAnswer = q.answer;
            let isCorrect = false;

            if (isTimeout) {
                feedbackEl.textContent = `‚è≥ Masa Tamat! Jawapan ialah ${correctAnswer}.`;
                feedbackEl.className = 'h-6 text-sm font-semibold text-red-600';
                playIncorrectSound();
            } else if (userAnswer === correctAnswer) {
                score++;
                isCorrect = true;
                feedbackEl.textContent = '‚úÖ Betul!';
                feedbackEl.className = 'h-6 text-sm font-semibold text-lime-600'; 
                playCorrectSound(); 
            } else {
                feedbackEl.textContent = `‚ùå Salah. Jawapan ialah ${correctAnswer}.`;
                feedbackEl.className = 'h-6 text-sm font-semibold text-red-600';
                playIncorrectSound(); 
            }

            if (currentMode === 'objective') {
                document.querySelectorAll('.objective-btn').forEach(btn => {
                    const value = parseInt(btn.getAttribute('data-value'));
                    btn.classList.remove('bg-teal-500', 'hover:bg-teal-600');
                    if (value === correctAnswer) {
                        btn.classList.add('bg-pink-600'); 
                    } else if (btn === selectedButton && !isCorrect) {
                        btn.classList.add('bg-red-600'); 
                    } else {
                         btn.classList.add('bg-teal-700'); 
                    }
                });
            }


            currentQIndex++;
            
            const progressPercent = (currentQIndex / 50) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;

            setTimeout(() => {
                if (currentMode === 'input') {
                    document.getElementById('answer-input').disabled = false;
                    document.querySelector('#input-mode button').disabled = false;
                }
                paparSoalan();
            }, 700);
        }
        
        // --- Logik TP DSKP ---
        
        // -----------------------------------------------------------------
        // FUNGSI PENGUMUMAN KEPUTUSAN KUIZ (Audio Sijil)
        // -----------------------------------------------------------------
        function announceResults(score, finalTP, tpLabel) {
            let resultMessage = "";
            
            // Sesuaikan mesej berdasarkan Tahap Penguasaan (TP)
            if (finalTP >= 5) {
                resultMessage = "TAHNIAH! Keputusan cemerlang! Anda memang bijak sifir dan sangat pantas! Anda mencapai Tahap Penguasaan lima ke atas!";
            } else if (finalTP >= 3) {
                resultMessage = "Hebat! Anda telah menguasai sifir. Sila teruskan latihan untuk mencapai Tahap Penguasaan yang lebih tinggi.";
            } else {
                resultMessage = "Anda telah mencuba. Jangan putus asa, mari cuba kuiz ini sekali lagi untuk tingkatkan markah dan kepantasan anda!";
            }
            
            // Mesej penuh yang akan dibaca oleh TTS
            const fullAnnouncement = `${resultMessage} Tahap Penguasaan anda adalah TP ${finalTP}. ${tpLabel}.`;
            
            // Panggil fungsi TTS yang telah diperbaiki
            speakMalay(fullAnnouncement);
        }
        // -----------------------------------------------------------------


        function getTPDetails(accuracy, timeElapsed, totalAnswered) {
            let finalTP = 1;
            let tpLabel = "Tahu";
            let tpDescription = "Tahu fakta asas sifir.";
            
            const avgTime = totalAnswered > 0 ? timeElapsed / totalAnswered : 999;
            const isAccurate = accuracy >= 0.8;
            const isVeryAccurate = accuracy >= 0.9; 
            const isNearPerfect = accuracy >= 0.96; 

            const veryFast = 4.0; 
            const fast = 7.0;    
            const moderate = 15.0; 


            if (isNearPerfect && avgTime <= veryFast) {
                finalTP = 6;
                tpLabel = "Cemerlang";
                tpDescription = "Menguasai sifir dengan cermat, tepat, cekap, dan **sangat pantas**, serta boleh menjadi teladan. Selesai kuiz dalam purata **< 4.0s** setiap soalan.";
            } else if (isVeryAccurate && avgTime <= fast) {
                finalTP = 5;
                tpLabel = "Sangat Mahir";
                tpDescription = "Melaksanakan kemahiran sifir dengan cermat, tepat, cekap, dan **pantas**. Selesai kuiz dalam purata **< 7.0s** setiap soalan.";
            } else if (isAccurate && avgTime <= moderate) {
                finalTP = 4;
                tpLabel = "Mahir";
                tpDescription = "Melaksanakan kemahiran sifir dengan cekap dan **tepat** dalam had masa yang berpatutan. Selesai kuiz dalam purata **< 15.0s** setiap soalan.";
            } else if (accuracy >= 0.7) {
                finalTP = 3;
                tpLabel = "Boleh Mengaplikasi";
                tpDescription = "Mengaplikasikan kefahaman sifir untuk melaksanakan kemahiran, tetapi perlukan latihan kepantasan dan ketepatan.";
            } else if (accuracy >= 0.5) {
                finalTP = 2;
                tpLabel = "Faham";
                tpDescription = "Memahami konsep sifir dan boleh menerangkan fakta asas, tetapi banyak jawapan salah.";
            } else {
                finalTP = 1;
                tpLabel = "Tahu";
                tpDescription = "Tahu fakta asas sifir (skor rendah), dan memerlukan banyak ulangkaji serta pengukuhan.";
            }
            
            return { finalTP, tpLabel, tpDescription, avgTime };
        }

        function tamatkanKuiz(isTotalTimeout = false) {
            hentikanTimer(); 

            const answeredQuestions = questions.slice(0, currentQIndex);
            const totalAnswered = answeredQuestions.length;
            const totalTimeTaken = answeredQuestions.reduce((sum, q) => sum + q.time, 0);

            const accuracy = score / 50;
            
            const finalPercentage = (score / 50) * 100;
            const incorrectCount = totalAnswered - score;

            let finalTP = 1;
            let tpLabel = "";
            let tpMessage = "";
            let tpDescription = "";
            let modeText = currentMode === 'objective' ? 'Objektif' : 'Input';
            let totalScore = score;
            let avgTime = 0;


            if (isTotalTimeout) {
                tpMessage = `‚ùå Had Masa Keseluruhan (250s) Kuiz ${modeText} Tamat! Kuiz terhenti pada soalan ${currentQIndex} dari 50.`;
                const partialAccuracy = score / totalAnswered;
                 if (partialAccuracy >= 0.7) {
                    finalTP = 3;
                    tpLabel = "Boleh Mengaplikasi";
                    tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Anda boleh mengaplikasi, tetapi perlukan latihan fokus dan ketepatan masa.";
                } else if (partialAccuracy >= 0.4) {
                    finalTP = 2;
                    tpLabel = "Faham";
                    tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Anda faham konsep, tetapi perlu tingkatkan kelajuan menjawab.";
                } else {
                    finalTP = 1;
                    tpLabel = "Tahu";
                    tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Perlu ulangkaji fakta sifir anda dengan lebih tekun.";
                }
                avgTime = totalAnswered > 0 ? totalTimeTaken / totalAnswered : 0;
                
                // Audio Keputusan apabila Masa Tamat
                announceResults(totalScore, finalTP, tpLabel);

            } else {
                const tpDetails = getTPDetails(accuracy, totalTimeTaken, totalAnswered);
                finalTP = tpDetails.finalTP;
                tpLabel = tpDetails.tpLabel;
                tpDescription = tpDetails.tpDescription;
                tpMessage = `üéâ Tahniah! Anda menyelesaikan Kuiz ${modeText} ini dengan jayanya.`;
                avgTime = tpDetails.avgTime;
                
                // Audio Keputusan Kuiz Tamat Biasa
                announceResults(totalScore, finalTP, tpLabel);
            }
            
            showScreen('result-screen');

            document.getElementById('final-tp').textContent = `TP${finalTP}`;
            document.getElementById('tp-label').textContent = tpLabel;
            document.getElementById('tp-description').textContent = tpDescription;
            document.getElementById('main-tp-message').textContent = tpMessage;
            
            document.getElementById('final-score').textContent = `${totalScore} / 50`;
            document.getElementById('final-percentage').textContent = `${finalPercentage.toFixed(1)}%`;

            document.getElementById('correct-count').textContent = totalScore;
            document.getElementById('incorrect-count').textContent = incorrectCount; 
            document.getElementById('average-time').textContent = avgTime.toFixed(2);
            
            const printBtn = document.getElementById('print-certificate-btn');
            printBtn.setAttribute('data-tp', finalTP);
            printBtn.setAttribute('data-label', tpLabel);
            printBtn.setAttribute('data-score', totalScore);

        }
        
        // --- Logik Sijil Pencapaian ---

        function generateCertificateHTML(finalTP, tpLabel, score) {
            const date = new Date().toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric' });
            // KEMASKINI: Gunakan nama pelajar dari localStorage/input
            const studentDisplayName = studentName.trim() || 'PELAJAR CEMERLANG'; 

            let colorClass, trophyIcon;
            if (finalTP >= 5) {
                colorClass = 'border-pink-600 text-pink-700 shadow-pink-300';
                trophyIcon = 'üèÜ';
            } else if (finalTP >= 3) {
                colorClass = 'border-teal-600 text-teal-700 shadow-teal-300';
                trophyIcon = 'üèÖ';
            } else {
                colorClass = 'border-yellow-600 text-yellow-700 shadow-yellow-300';
                trophyIcon = '‚ú®';
            }


            return `
                <div class="certificate-container w-full max-w-4xl border-8 rounded-xl p-8 md:p-16 shadow-2xl ${colorClass} bg-white mx-auto my-auto" style="min-height: 80vh;">
                    
                    <p class="brand-marykate text-center mb-4 text-lg">Edukids by Mizz</p>
                    
                    <div class="text-center space-y-4">
                        <h1 class="text-4xl md:text-5xl font-black mb-6 mt-4 uppercase tracking-widest text-teal-600">
                            Sijil Pencapaian
                        </h1>
                        
                        <p class="text-xl font-semibold text-gray-700">
                            Dengan sukacitanya dianugerahkan kepada:
                        </p>
                        
                        <p class="text-4xl md:text-5xl font-extrabold border-b-2 border-solid mx-auto pb-2 max-w-sm ${colorClass}">
                            ${studentDisplayName.toUpperCase()}
                        </p>
                        
                        <p class="text-xl font-semibold pt-4 text-gray-700">
                            Di atas kejayaan menamatkan 50 soalan Kuiz Bijak Sifir dengan
                        </p>
                        
                        <div class="py-4 px-6 mx-auto max-w-xs rounded-xl shadow-lg ring-4 ${colorClass.replace('border-', 'bg-').replace('shadow-', 'ring-')}" style="background-color: ${finalTP >= 5 ? '#fbcfe8' : finalTP >= 3 ? '#99f6e4' : '#fef08a'}">
                            <p class="text-2xl font-bold">Tahap Penguasaan</p>
                            <p class="text-6xl font-black mt-2">${trophyIcon} TP${finalTP}</p>
                            <p class="text-3xl font-extrabold mt-1 uppercase">${tpLabel}</p>
                        </div>

                        <p class="text-xl font-semibold pt-4 text-gray-700">
                            Skor Akhir: ${score} / 50
                        </p>
                    </div>

                    <div class="flex flex-col md:flex-row justify-around items-end mt-12 text-sm text-gray-700">
                        <div class="text-center">
                            <p class="border-t border-gray-500 pt-2 font-medium italic">
                                Tarikh Dikeluarkan: ${date}
                            </p>
                        </div>
                        <div class="text-center mt-6 md:mt-0">
                            <p class="border-t border-gray-500 pt-2 font-medium">
                                Guru Cemerlang Matematik
                            </p>
                            <p class="text-xs text-gray-500">(Tandatangan Digital)</p>
                        </div>
                    </div>
                    
                    <div class="no-print text-center mt-8">
                        <button onclick="window.print();" class="bg-pink-500 hover:bg-pink-600 text-white font-medium py-2 px-6 rounded-lg transition duration-150 shadow-md mr-4">
                            Cetak ke PDF
                        </button>
                        <button onclick="returnFromCertificate()" class="bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-6 rounded-lg transition duration-150 shadow-md">
                            Tutup Sijil & Buat Kuiz Baharu
                        </button>
                    </div>
                </div>
            `;
        }

        function displayCertificateForPrint() {
            const printBtn = document.getElementById('print-certificate-btn');
            const finalTP = parseInt(printBtn.getAttribute('data-tp'));
            const tpLabel = printBtn.getAttribute('data-label');
            const score = parseInt(printBtn.getAttribute('data-score'));

            const certificateHTML = generateCertificateHTML(finalTP, tpLabel, score);
            const certificateScreen = document.getElementById('certificate-screen');
            
            certificateScreen.innerHTML = certificateHTML;
            certificateScreen.classList.remove('hidden');

            document.getElementById('quiz-container-wrapper').classList.add('hidden');
            
            speakMalay(`Sijil anda telah sedia. Sila cetak atau simpan sebagai PDF.`);
        }

        function returnFromCertificate() {
            const certificateScreen = document.getElementById('certificate-screen');
            
            certificateScreen.classList.add('hidden');
            
            document.getElementById('quiz-container-wrapper').classList.remove('hidden');
            
            certificateScreen.innerHTML = '';
            
            showScreen('selection-screen');
            speakMalay('Sila buat pilihan kuiz baharu.');
        }
    </script>
</body>

</html>
