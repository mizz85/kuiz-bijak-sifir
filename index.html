<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Bijak Sifir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
<style>
    /* Muatkan font 'Inter' */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    /* Gaya Font Standard untuk Jenama - Dikekalkan sekiranya digunakan di tempat lain */
    .brand-marykate {
        font-family: 'Inter', sans-serif; 
        color: #ec4899; /* Pink 500 */
        font-size: 0.875rem; /* Saiz dikurangkan ke text-sm */
        line-height: 1.5rem;
        font-weight: 900; /* Extra Black */
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .result-score {
        /* Warna bayangan diselaraskan dengan warna Merah Jambu (Pink) */
        animation: pulse-score 1.5s infinite;
    }
    @keyframes pulse-score {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(236, 72, 153, 0.7); /* Pink 500 Shadow */ }
        100% { transform: scale(1); }
    }
    /* Style untuk pemasa soalan yang mendesak (3s terakhir) */
    .urgent-timer {
        color: #fff; /* Teks putih */
        background-color: #ef4444; /* Red 500 */
        border-color: #fca5a5; /* Red 300 */
        animation: urgent-pulse 0.5s infinite;
    }
    @keyframes urgent-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Benarkan scrolling pada skrin sijil jika kandungan panjang */
    #certificate-screen {
        overflow-y: auto; 
    }

    /* Gaya baru untuk menyembunyikan elemen TP secara visual */
    .tp-hidden {
         display: none;
    }

    /* Gaya untuk Cetakan Sijil (A4 PORTRAIT) */
    @media print {
        
        /* 1. KUNCI UTAMA: Tetapkan saiz halaman kepada A4 PORTRAIT */
        @page {
            size: A4 portrait; /* Kembali ke saiz kertas A4 tegak */
            margin: 0.8cm;     /* Margin A4 standard */
        }

        body {
            margin: 0;
            padding: 0;
            background-color: white !important;
            display: block; 
        }
        
        #quiz-container-wrapper, #cert-controls {
            display: none !important;
        }
        
        #certificate-screen {
            position: static !important;
            display: block !important;
            margin: auto;
            padding: 0; 
            max-width: none; 
            max-height: none; 
            overflow: hidden; 
        }
        
        #certificate-content {
            box-shadow: none !important;
            border: none !important;
            /* Saiz untuk A4 Portrait (21.0cm x 29.7cm) */
            min-height: 27.7cm; /* Tinggi penuh A4 */
            width: 19.4cm;      /* Lebar penuh A4 */
            padding: 2cm 1.5cm !important; /* Padding disesuaikan untuk A4 */
            font-size: 1em; /* Saiz font asas kembali normal */
        }
        
        /* Saiz font disesuaikan kembali untuk muat pada kertas A4 Portrait */
        #certificate-content .text-5xl { font-size: 2.5rem !important; } /* Saiz TP/Skor */
        #certificate-content .text-6xl { font-size: 3.5rem !important; } /* Saiz Nama */
        #certificate-content .text-4xl { font-size: 2rem !important; } /* SIJIL PENGHARGAAN */
        #certificate-content .text-2xl { font-size: 1.5rem !important; } /* Tajuk Kuiz */
        #certificate-content .text-lg { font-size: 1rem !important; } /* teks biasa */

        /* Sesuaikan jarak elemen dalam sijil kembali ke ukuran A4 */
        #certificate-content .my-4 { margin-top: 1rem !important; margin-bottom: 1rem !important; }
        #certificate-content .pt-4 { padding-top: 1rem !important; }
        #certificate-content .pt-4 + div { padding-top: 1rem !important; } 
        #certificate-content .mt-6 { margin-top: 1.5rem !important; }
        .flex-col .space-y-3 { margin-top: 1.5rem !important; }

        .print\:hidden {
            display: none !important;
        }
    }
    </style>
</head>
<body class="bg-yellow-50 min-h-screen flex items-center justify-center p-4">
	<div id="quiz-container-wrapper" class="w-full max-w-md bg-white p-6 rounded-xl shadow-xl border-3 border-pink-300">
		
		<div class="flex flex-col items-center justify-center mb-5">
            <img src="https://raw.githubusercontent.com/mizz85/nota-sifir/main/logo-mizzz.png" alt="Logo Edukids by Mizz" class="w-40 h-auto mb-2">
            <h1 class="text-2xl font-extrabold text-teal-600 text-center">
                Kuiz Bijak Sifir
            </h1>
            </div>

        <div id="quiz-container">
            
            <div id="login-screen" class="space-y-4">
                <p class="text-gray-600 text-center text-sm font-semibold">
                    Akses terhad. Sila masukkan Kata Laluan untuk meneruskan.
                </p>

                <div class="space-y-2">
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Kata Laluan:</label>
                    <input type="text" id="password-input" placeholder="Masukkan Kata Laluan" class="w-full p-3 text-center text-lg font-bold border-3 border-pink-400 rounded-lg focus:border-teal-500 focus:ring-4 focus:ring-teal-200" onkeydown="handleLoginKey(event)" autofocus>
                    <p id="login-feedback" class="h-6 text-sm font-semibold text-red-600 text-center"></p>
                </div>

                <button onclick="checkPassword()" id="login-button" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                    Log Masuk
                </button>
               <p class="text-xs text-gray-500 text-center mt-3">
    Lupa atau Tiada Kata Laluan?
    <a href="https://wa.me/60198950339?text=Assalamualaikum.%20Saya%20memohon%20kata%20laluan%20untuk%20Kuiz%20Bijak%20Sifir.%20Nama%20saya%20[Nama%20Pelajar/Ibu%20Bapa]." target="_blank" class="font-bold text-pink-500 hover:text-pink-600 transition duration-150">
        Minta Kata Laluan (WhatsApp Mizz).
    </a>
</p>
            </div>
            
            <div id="selection-screen" class="hidden space-y-4">
                
                <div class="space-y-2 p-3 bg-teal-50 rounded-lg border border-teal-300">
                    <label for="student-name-input" class="block text-sm font-black text-teal-700">
                        Masukkan Nama Pelajar:
                    </label>
                    <input 
                        type="text" 
                        id="student-name-input" 
                        placeholder="Cth: Sofea Binti Shamsul" 
                        class="w-full p-3 text-center text-base font-bold border-2 border-teal-500 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200" 
                        oninput="updateAndSaveName(event)"
                    >
                    <p id="current-name-display" class="text-xs text-gray-600 italic mt-1 text-center"></p>
                </div>

                <!-- KAWALAN SUIS AUDIO DIPISAHKAN -->
                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg border border-gray-300">
                    <label for="tone-toggle" class="text-sm font-black text-gray-700">
                        üîî Audio Bunyi (Nada Betul/Salah & Bip Amaran)
                    </label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="tone-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                    </label>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg border border-gray-300">
                    <label for="tts-toggle" class="text-sm font-black text-gray-700">
                        üó£Ô∏è Suara (Teks-ke-Ucapan / TTS)
                    </label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="tts-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                    </label>
                </div>
                <!-- AKHIR KAWALAN SUIS AUDIO DIPISAHKAN -->
                
                <!-- NOTA BARU MENGENAI TTS -->
                <p class="text-xs italic text-red-700 p-2 text-center bg-red-100 rounded-lg border border-red-300 -mt-2">
                    ‚ö†Ô∏è Nota: Jika suara TTS tidak seperti penutur Melayu yang fasih, anda disyorkan untuk **MATIKAN SUARA** (Off) bagi mengelakkan gangguan konsentrasi atau fokus.
                </p> 
                <!-- AKHIR NOTA BARU -->
                
                <p class="text-gray-600 text-center text-sm">
                    Sila pilih jenis kuiz dan sifir yang ingin diuji.
                </p>

                <div class="space-y-2">
                    <label for="sifir-pilihan" class="block text-sm font-medium text-gray-700">Pilih Jenis Ujian:</label>
                    <select id="sifir-pilihan" class="w-full p-3 border-2 border-pink-400 rounded-lg shadow-md focus:ring-teal-500 focus:border-teal-500 bg-white text-teal-700 font-semibold text-sm">
                        <option value="0-objective-50">üéØ Semua Sifir (1-12) - Objektif A/B/C/D (50 Soalan)</option>
                        <option value="0-input-50">‚úçÔ∏è Semua Sifir (1-12) - Input Jawapan (50 Soalan)</option>
                        
                        <option disabled>--- Sifir Tunggal (30 Soalan) ---</option>
                        <option value="2-objective-30">üéØ Sifir 2 - Objektif (30 Soalan, 7s)</option>
                        <option value="3-objective-30">üéØ Sifir 3 - Objektif (30 Soalan, 7s)</option>
                        <option value="4-objective-30">üéØ Sifir 4 - Objektif (30 Soalan, 7s)</option>
                        <option value="5-objective-30">üéØ Sifir 5 - Objektif (30 Soalan, 7s)</option>
                        <option value="6-objective-30">üéØ Sifir 6 - Objektif (30 Soalan, 7s)</option>
                        <option value="7-objective-30">üéØ Sifir 7 - Objektif (30 Soalan, 7s)</option>
                        <option value="8-objective-30">üéØ Sifir 8 - Objektif (30 Soalan, 7s)</option>
                        <option value="9-objective-30">üéØ Sifir 9 - Objektif (30 Soalan, 7s)</option>
                        <option value="10-objective-30">üéØ Sifir 10 - Objektif (30 Soalan, 7s)</option>
                        <option value="11-objective-30">üéØ Sifir 11 - Objektif (30 Soalan, 7s)</option>
                        <option value="12-objective-30">üéØ Sifir 12 - Objektif (30 Soalan, 7s)</option>
                        
                        <option value="2-input-30">‚úçÔ∏è Sifir 2 (30 Soalan, 10s)</option>
                        <option value="3-input-30">‚úçÔ∏è Sifir 3 (30 Soalan, 10s)</option>
                        <option value="4-input-30">‚úçÔ∏è Sifir 4 (30 Soalan, 10s)</option>
                        <option value="5-input-30">‚úçÔ∏è Sifir 5 (30 Soalan, 10s)</option>
                        <option value="6-input-30">‚úçÔ∏è Sifir 6 (30 Soalan, 10s)</option>
                        <option value="7-input-30">‚úçÔ∏è Sifir 7 (30 Soalan, 10s)</option>
                        <option value="8-input-30">‚úçÔ∏è Sifir 8 (30 Soalan, 10s)</option>
                        <option value="9-input-30">‚úçÔ∏è Sifir 9 (30 Soalan, 10s)</option>
                        <option value="10-input-30">‚úçÔ∏è Sifir 10 (30 Soalan, 10s)</option>
                        <option value="11-input-30">‚úçÔ∏è Sifir 11 (30 Soalan, 10s)</option>
                        <option value="12-input-30">‚úçÔ∏è Sifir 12 (30 Soalan, 10s)</option>
                    </select>
                </div>

                <button onclick="startQuizFlow()" id="start-button" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                    Mulakan Kuiz
                </button>
            </div>

            <div id="quiz-screen" class="hidden text-center space-y-4">
                
                <div class="w-full flex justify-between items-center mb-3">
                    <div class="w-3/4 bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="bg-pink-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                    </div>
                    <div id="q-countdown-display" class="text-lg font-black text-teal-600 border-2 border-teal-300 px-3 py-0.5 rounded-full shadow-md transition-colors duration-300">
                        7s
                    </div>
                </div>

                <p class="text-xs text-gray-500">
                    Soalan <span id="current-q-num">1</span> dari <span id="total-q-display">50</span>
                </p>
                <span id="total-time-tracker" class="hidden">0</span>

                <div class="bg-yellow-200 p-6 rounded-xl shadow-lg border-2 border-yellow-500">
                    <p class="text-lg text-gray-500 mb-1">Berapakah</p>
                    <p id="question-text" class="text-4xl font-extrabold text-teal-800">
                        7 x 8 ?
                    </p>
                </div>

                <div id="input-mode" class="space-y-3">
                    <input type="number" id="answer-input" placeholder="Jawab di sini" class="w-full p-3 text-center text-2xl font-bold border-3 border-pink-400 rounded-lg focus:border-teal-500 focus:ring-4 focus:ring-teal-200" onkeydown="handleInputKey(event)" autofocus>

                    <button onclick="handleInputSubmission()" class="w-full bg-lime-500 hover:bg-lime-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                        Hantar Jawapan
                    </button>
                </div>

                <div id="objective-mode" class="hidden grid grid-cols-2 gap-3">
                    <button id="option-A" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        A. <span></span>
                    </button>
                    <button id="option-B" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        B. <span></span>
                    </button>
                    <button id="option-C" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        C. <span></span>
                    </button>
                    <button id="option-D" onclick="handleObjectiveSubmission(this)" data-value="" class="objective-btn p-3 text-xl font-bold text-white bg-teal-500 rounded-lg hover:bg-teal-600 transition duration-150 shadow-md">
                        D. <span></span>
                    </button>
                </div>


                <div id="feedback" class="h-6 text-sm font-semibold"></div>

                <button onclick="returnToSelection()" class="w-full bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold text-sm py-2 rounded-lg transition duration-150 shadow-sm mt-4">
                    Kembali ke Pilihan Sifir
                </button>
            </div>

            <div id="result-screen" class="hidden text-center space-y-4">
                
                <div id="quiz-result-title" class="mb-3">
                    <h2 class="text-xl font-bold text-teal-700 leading-tight">Keputusan Kuiz Anda</h2>
                    <p id="sifir-title-display" class="text-2xl font-extrabold text-pink-600 leading-tight">Sifir</p>
                </div>

                <div id="student-result-name" class="text-xl font-extrabold text-pink-600 mb-3 -mt-2">
                    [Nama Pelajar Akan Dipaparkan Di Sini]
                </div>
                
                <p id="main-tp-message" class="text-base font-semibold text-gray-700"></p>

                <div id="tp-display-group">
                    <div class="p-4 bg-yellow-100 rounded-xl border-3 border-yellow-500">
                        <p class="text-base font-semibold text-gray-700">Tahap Penguasaan (TP) Dicapai:</p>
                        <p id="final-tp" class="text-6xl font-black text-pink-600 result-score mt-1">TPX</p>
                        <p id="tp-label" class="text-xl font-extrabold text-teal-600 mt-1">Label TP</p>
                    </div>

                    <div class="p-3 bg-pink-100 rounded-lg border border-pink-400 text-left">
                        <p class="text-sm font-bold text-pink-700 mb-1">Penerangan Tahap:</p>
                        <p id="tp-description" class="text-sm text-gray-800 italic">
                            [Penerangan terperinci mengikut DSKP akan dipaparkan di sini.]
                        </p>
                    </div>
                </div>
                <div class="text-left space-y-2 text-sm text-gray-700">
                    <p>‚≠ê Skor Anda: <span id="final-score" class="font-bold text-teal-600"></span></p>
                    <p>üìä Peratusan: <span id="final-percentage" class="font-bold text-teal-600"></span></p>
                    <p>‚úÖ Jawapan Betul: <span id="correct-count" class="font-bold text-lime-600"></span></p>
                    <p>‚ùå Jawapan Salah: <span id="incorrect-count" class="font-bold text-red-600"></span></p>
                    <p>‚è±Ô∏è Purata Masa Tindak Balas: <span id="average-time" class="font-bold"></span> saat</p>
                </div>
                
                <button onclick="startNewQuizSelection()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl mt-3">
                    Ulang Kuiz (Pilihan Sifir)
                </button>
            </div>
        </div>
    </div>
    
    <div id="certificate-screen" class="hidden fixed inset-0 z-50 bg-white items-center justify-center p-4 overflow-y-auto">
        
        <div id="certificate-content" class="w-full max-w-4xl p-8 md:p-12 bg-white shadow-2xl border-4 border-pink-500 rounded-xl relative">
            <div class="text-center space-y-4">
                
                <img src="https://raw.githubusercontent.com/mizz85/nota-sifir/main/logo-mizzz.png" alt="Logo Edukids by Mizz" class="mx-auto w-48 h-auto mb-2"/>
                <h1 class="text-4xl md:text-5xl font-black text-teal-700">SIJIL PENGHARGAAN</h1>
                
                <p class="text-lg text-gray-700 pt-4">Dengan sukacitanya diperakui bahawa</p>
                
                <p id="cert-student-name" class="text-3xl md:text-6xl font-extrabold text-pink-600 my-4 py-2 border-b-4 border-pink-200 inline-block px-8">
                    [NAMA PELAJAR]
                </p>

                <p class="text-lg text-gray-700">Telah berjaya menyelesaikan</p>
                
                <h2 id="cert-quiz-title" class="text-2xl md:text-3xl font-bold text-teal-600 mt-2">
                    Kuiz Bijak Sifir Gabungan (1-12)
                </h2>
                
                <div class="flex flex-col md:flex-row justify-center space-y-3 md:space-y-0 md:space-x-8 mt-6 text-left">
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300">
                        <p class="text-base font-semibold text-gray-700">Tahap Penguasaan (TP):</p>
                        <p id="cert-tp" class="text-5xl font-black text-pink-600 mt-1">TPX</p>
                    </div>
                    <div class="bg-lime-50 p-4 rounded-lg border border-lime-300">
                        <p class="text-base font-semibold text-gray-700">Pencapaian Skor:</p>
                        <p id="cert-score" class="text-5xl font-black text-lime-600 mt-1">100%</p>
                    </div>
                    <div class="bg-teal-50 p-4 rounded-lg border border-teal-300">
                        <p class="text-base font-semibold text-gray-700">Purata Masa (s):</p>
                        <p id="cert-avg-time" class="text-5xl font-black text-teal-600 mt-1">0.00s</p>
                    </div>
                </div>

                <p class="text-sm italic text-gray-500 pt-4">
                    Dikeluarkan pada <span id="cert-date">1 Januari 2024</span>
                </p>
                
                <div class="flex flex-col items-center mt-6">
                    <img src="https://raw.githubusercontent.com/mizz85/kuiz-bijak-sifir/main/MizzSignature.png" alt="Tandatangan Mizz" class="w-48 h-auto mb-1"> 
                    <p class="text-lg font-bold text-gray-800">Mizz</p>
                    <p class="text-sm font-semibold text-teal-600">Ketua Projek Pembangunan Bijak Sifir</p>
                </div>
                </div>
        </div>
        <div id="cert-controls" class="w-full max-w-4xl p-4 mt-4 print:hidden flex flex-col space-y-2">
            <button onclick="window.print()" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl">
                üñ®Ô∏è Cetak / Simpan PDF Sijil
            </button>
            <button onclick="closeCertificate()" class="w-full bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold text-sm py-2 rounded-lg transition duration-150 shadow-sm">
                Kembali ke Keputusan
            </button>
        </div>
        </div>

    <script>
        // Global State Variables
        const QUIZ_DURATION = 250;     
        const CORRECT_PASSWORD = 'KuizSifir5973';
        
        let audioContext = null;
        let currentSifir = 0;
        let currentMode = 'input'; 
        let totalQuestions = 50; 
        let isCombinedQuiz = true; 
        let questionDuration = 7; 

        // STATE AUDIO BARU DIPISAHKAN
        let isToneEnabled = true; // Untuk nada (bunyi)
        let isTTSEnabled = true;  // Untuk suara (Teks-ke-Ucapan)

        let questions = [];
        let currentQIndex = 0;
        let score = 0;
        let totalTimeElapsed = 0; 
        
        let totalTimeInterval = null; 
        let qTimerInterval = null;    
        let qTimeLeft = 7; 
        let warningBeepInterval = null; 
        
        let studentName = '';
        const STORAGE_KEY_NAME = 'student_name_sifir'; 
        const STORAGE_KEY_TONE = 'is_tone_enabled';
        const STORAGE_KEY_TTS = 'is_tts_enabled';

        // --- Logik Local Storage ---
        
        function loadSettingsLocally() {
            // Muatkan Nama
            const storedName = localStorage.getItem(STORAGE_KEY_NAME);
            if (storedName) {
                studentName = storedName;
                document.getElementById('student-name-input').value = studentName;
                document.getElementById('current-name-display').textContent = `Nama yang disimpan: ${studentName}`;
            } else {
                 document.getElementById('current-name-display').textContent = `Nama belum disimpan.`;
            }
            
            // Muatkan State Tone/Bunyi
            const storedTone = localStorage.getItem(STORAGE_KEY_TONE);
            if (storedTone !== null) {
                isToneEnabled = storedTone === 'true';
            }
            document.getElementById('tone-toggle').checked = isToneEnabled;

            // Muatkan State TTS/Suara
            const storedTTS = localStorage.getItem(STORAGE_KEY_TTS);
            if (storedTTS !== null) {
                isTTSEnabled = storedTTS === 'true';
            }
            document.getElementById('tts-toggle').checked = isTTSEnabled;

            // Hentikan TTS jika dimatikan semasa muat (untuk mengelakkan suara TTS sedia ada)
            if (!isTTSEnabled) {
                window.speechSynthesis.cancel();
            }
        }

        function updateAndSaveName(event) {
            const name = event.target.value.trim();
            studentName = name;
            localStorage.setItem(STORAGE_KEY_NAME, name);
            
            if (name) {
                document.getElementById('current-name-display').textContent = `Nama yang disimpan: ${name}`;
            } else {
                 document.getElementById('current-name-display').textContent = `Nama belum disimpan.`;
            }
        }
        
        loadSettingsLocally(); 
        
        // --- Akhir Logik Local Storage ---

        // NEW: Logik Togol Audio
        document.addEventListener('DOMContentLoaded', () => {
            const toneToggle = document.getElementById('tone-toggle');
            const ttsToggle = document.getElementById('tts-toggle');

            if (toneToggle) {
                toneToggle.addEventListener('change', (event) => {
                    isToneEnabled = event.target.checked;
                    localStorage.setItem(STORAGE_KEY_TONE, isToneEnabled);
                    if (!isToneEnabled) {
                        stopWarningBeeps(); // Hentikan bip amaran jika bunyi dimatikan
                    }
                });
            }
            
            if (ttsToggle) {
                 ttsToggle.addEventListener('change', (event) => {
                    isTTSEnabled = event.target.checked;
                    localStorage.setItem(STORAGE_KEY_TTS, isTTSEnabled);
                    if (!isTTSEnabled) {
                        window.speechSynthesis.cancel(); // Hentikan TTS sedia ada
                    }
                });
            }
        });
        // END NEW: Logik Togol Audio

        // Helper function untuk menukar paparan skrin
        function showScreen(screenId) {
            const screens = ['login-screen', 'selection-screen', 'quiz-screen', 'result-screen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Utility: Fisher-Yates shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }

        // -----------------------------------------------------------------
        // FUNGSI TTS & Audio
        // -----------------------------------------------------------------
        function speakMalay(textToRead) {
            if (!isTTSEnabled) return; // SEMAKAN TTS
            
            if (!('speechSynthesis' in window)) {
                console.error("Pelayar tidak menyokong Web Speech API.");
                return;
            }
            window.speechSynthesis.cancel();
            
            try {
                const utterance = new SpeechSynthesisUtterance(textToRead);
                utterance.lang = 'ms-MY';
                utterance.rate = 1.0; 

                const voices = window.speechSynthesis.getVoices();
                let malayVoice = voices.find(voice => 
                    voice.lang === 'ms-MY' || 
                    voice.name.toLowerCase().includes('malay') || 
                    voice.name.toLowerCase().includes('melayu')
                );

                if (malayVoice) {
                    utterance.voice = malayVoice;
                } else {
                    console.warn("Suara Bahasa Melayu (ms-MY) tidak ditemui. Menggunakan suara lalai sistem.");
                }

                window.speechSynthesis.speak(utterance);

            } catch (error) {
                 console.error("Ralat TTS: Audio gagal dimainkan.", error);
            }
        }

        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API tidak boleh dimulakan:", e);
                }
            }
        }
        
        document.getElementById('login-button').addEventListener('click', initAudio, { once: true });
        document.getElementById('password-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') initAudio();
        }, { once: true });


        function playTone(frequency, duration, type = 'sine') {
            initAudio();
            if (!audioContext || !isToneEnabled) return; // SEMAKAN TONE/BUNYI
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = type;
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playCorrectSound() {
            playTone(880, 0.15, 'sine'); 
        }

        function playIncorrectSound() {
            playTone(220, 0.3, 'triangle'); 
        }

        function playWarningBeep() {
            playTone(800, 0.1, 'square');
        }

        function startWarningBeeps() {
            if (!isToneEnabled) return; // SEMAKAN TONE/BUNYI
            if (warningBeepInterval) return;
            warningBeepInterval = setInterval(() => {
                if (qTimeLeft <= 3 && qTimeLeft > 0) { 
                   playWarningBeep();
                }
            }, 500);
        }

        function stopWarningBeeps() {
            if (warningBeepInterval) {
                clearInterval(warningBeepInterval);
                warningBeepInterval = null;
            }
        }
        // -----------------------------------------------------------------
        
        // *** FUNGSI BARU: PENGESAN PELAYAR DALAMAN ***
        function isMobileInAppBrowser() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            
            // Logik untuk mengesan In-App Browser (WhatsApp, Facebook, Line, dsb.)
            const isInApp = /FB_IAB|FBAV|Instagram|Line|KAKAOTALK|CriOS|WebView|wv/i.test(ua);
            
            // Mengesan pelayar utama (Chrome, Safari, Firefox, Edge)
            const isMajorBrowser = /Chrome|Safari|Firefox|Edg/i.test(ua) && !/wv/i.test(ua);
            
            // Anggap sebagai Pelayar Dalaman jika mengandungi tag In-App ATAU 
            // jika ia peranti Mobile tetapi bukan pelayar utama yang dijangka.
            return isInApp || (!isMajorBrowser && /Mobile/i.test(ua));
        }
        // **********************************************


        // --- Logik Akses Kata Laluan ---
        function checkPassword() {
            const input = document.getElementById('password-input').value.trim();
            const feedback = document.getElementById('login-feedback');
            
            if (input === CORRECT_PASSWORD) {
                feedback.textContent = 'Log Masuk Berjaya!';
                feedback.classList.remove('text-red-600');
                feedback.classList.add('text-lime-600');
                
                showScreen('selection-screen'); 
                
                loadSettingsLocally(); // Muatkan setting selepas login
                document.getElementById('student-name-input').focus();
                
                speakMalay(`Selamat Datang ke Kuiz Bijak Sifir! Sila masukkan nama anda dan pilih jenis kuiz.`);

            } else {
                playIncorrectSound(); 
                feedback.textContent = 'Kata Laluan Salah. Sila cuba lagi.';
                feedback.classList.remove('text-lime-600');
                feedback.classList.add('text-red-600');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }
        function handleLoginKey(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        }
        
        // --- Logik Kuiz ---

        function generateDistractors(correctAnswer) {
            const distractors = new Set();
            const maxAttempts = 10;
            let attempts = 0;
            
            while (distractors.size < 3 && attempts < maxAttempts) {
                attempts++;
                let offset = Math.floor(Math.random() * 11) - 5; 
                let distractor = correctAnswer + offset;

                if (distractor > 0 && distractor !== correctAnswer && !distractors.has(distractor)) {
                    distractors.add(distractor);
                }
            }
            
            if (distractors.size < 3) {
                 [1, -1, 10, correctAnswer % 10 === 0 ? -10 : 0].forEach(offset => {
                    let d = correctAnswer + offset;
                    if (d > 0 && d !== correctAnswer && distractors.size < 3 && !distractors.has(d)) {
                         distractors.add(d);
                    }
                });
            }

            return Array.from(distractors).slice(0, 3);
        }

        function generateQuestions(sifir, mode, count) {
            questions = [];
            
            for (let i = 0; i < count; i++) {
                let multiplier;
                let factor = Math.floor(Math.random() * 12) + 1; 

                if (sifir === 0) {
                    multiplier = Math.floor(Math.random() * 12) + 1; 
                } else {
                    multiplier = sifir;
                }

                const correctAnswer = multiplier * factor;
                const qText = `${multiplier} x ${factor}`;
                const newQuestion = { q: qText, answer: correctAnswer, time: 0, answered: false }; 

                if (mode === 'objective') {
                    const distractors = generateDistractors(correctAnswer);
                    let options = [...distractors, correctAnswer];
                    shuffleArray(options); 

                    newQuestion.options = options;
                }

                questions.push(newQuestion);
            }
        }


        function startQuizFlow() {
            // Semak nama pelajar
            if (!studentName.trim()) {
                speakMalay('Sila masukkan nama pelajar terlebih dahulu.');
                document.getElementById('student-name-input').focus();
                
                const startButton = document.getElementById('start-button');
                startButton.textContent = 'Sila masukkan nama pelajar!';
                startButton.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                startButton.classList.add('bg-red-500', 'hover:bg-red-600');
                setTimeout(() => {
                    startButton.textContent = 'Mulakan Kuiz';
                    startButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                    startButton.classList.add('bg-pink-500', 'hover:bg-pink-600');
                }, 1500);
                return;
            }


            const selection = document.getElementById('sifir-pilihan').value.split('-');
            currentSifir = parseInt(selection[0]);
            currentMode = selection[1];
            totalQuestions = parseInt(selection[2]); 
            
            // Tentukan jenis kuiz untuk logik TP
            isCombinedQuiz = (currentSifir === 0);
            
            // Tentukan Masa Soalan
            if (isCombinedQuiz) {
                // Kuiz Gabungan 50 soalan (Objektif 7s / Input 10s)
                questionDuration = (currentMode === 'input') ? 10 : 7; 
            } else if (currentMode === 'input') {
                // Sifir Tunggal Input Jawapan 30 soalan
                questionDuration = 10; 
            } else {
                // Sifir Tunggal Objektif 30 soalan
                questionDuration = 7;
            }


            generateQuestions(currentSifir, currentMode, totalQuestions);

            currentQIndex = 0;
            score = 0;
            totalTimeElapsed = 0;
            
            hentikanTimer(); 

            document.getElementById('progress-bar').style.width = `0%`;
            document.getElementById('q-countdown-display').textContent = `${questionDuration}s`; 
            document.getElementById('total-q-display').textContent = totalQuestions; 

            showScreen('quiz-screen');

            const inputModeEl = document.getElementById('input-mode');
            const objectiveModeEl = document.getElementById('objective-mode');

            if (currentMode === 'input') {
                inputModeEl.classList.remove('hidden');
                objectiveModeEl.classList.add('hidden');
                document.getElementById('answer-input').focus();
            } else { 
                inputModeEl.classList.add('hidden');
                objectiveModeEl.classList.remove('hidden');
                document.getElementById('option-A').focus();
            }

            mulakanTotalTimer();

            speakMalay(`Jom mulakan Kuiz Sifir! Anda ada ${questionDuration} saat untuk setiap soalan.`);

            paparSoalan();
        }
        
        function returnToSelection() {
            hentikanTimer();
            currentQIndex = 0;
            score = 0;
            totalTimeElapsed = 0;

            speakMalay('Kuiz ditamatkan. Sila buat pilihan baharu.');
            showScreen('selection-screen');
        }

        function startNewQuizSelection() {
            // Tutup skrin sijil jika ada
            closeCertificate(); 
            
            // Buang butang cetak lama dari DOM agar boleh dijana semula
            const oldCertButton = document.getElementById('print-certificate-button');
            if (oldCertButton) {
                oldCertButton.remove();
            }

            speakMalay('Sila pilih jenis kuiz yang baru.');
            showScreen('selection-screen'); 
        }

        function paparSoalan() {
            hentikanQuestionTimer();

            if (currentQIndex >= totalQuestions) { 
                tamatkanKuiz();
                return;
            }

            const q = questions[currentQIndex];
            document.getElementById('question-text').textContent = q.q + ' = ?';
            document.getElementById('current-q-num').textContent = currentQIndex + 1;
            document.getElementById('feedback').textContent = '';

            if (currentMode === 'input') {
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
            } else { 
                document.querySelectorAll('.objective-btn').forEach((btn, index) => {
                    const optionValue = q.options[index];
                    btn.classList.remove('bg-pink-600', 'bg-red-600', 'bg-teal-700');
                    btn.classList.add('bg-teal-500', 'hover:bg-teal-600'); 
                    
                    btn.querySelector('span').textContent = optionValue;
                    btn.setAttribute('data-value', optionValue);
                    btn.disabled = false;
                });
            }
            
            mulakanQuestionTimer();
        }
        
        // --- Pengurusan Masa Soalan (Countdown) ---

        function mulakanQuestionTimer() {
            qTimeLeft = questionDuration; 
            const displayEl = document.getElementById('q-countdown-display');
            displayEl.textContent = `${qTimeLeft}s`;
            
            displayEl.classList.remove('urgent-timer');
            stopWarningBeeps(); 

            qTimerInterval = setInterval(() => {
                qTimeLeft--;
                displayEl.textContent = `${qTimeLeft}s`;
                
                if (qTimeLeft <= 3 && qTimeLeft > 0) {
                    displayEl.classList.add('urgent-timer');
                    if (!warningBeepInterval) { 
                        startWarningBeeps(); // Mula bip amaran (jika dibenarkan)
                    }
                } else if (qTimeLeft <= 0) {
                    hentikanQuestionTimer();
                    semakJawapan(null, null, true); 
                } else if (qTimeLeft > 3) {
                    displayEl.classList.remove('urgent-timer');
                    stopWarningBeeps();
                }
            }, 1000); 
        }

        function hentikanQuestionTimer() {
            clearInterval(qTimerInterval);
            stopWarningBeeps();
            qTimerInterval = null;
        }
        
        // --- Pengurusan Masa Keseluruhan (250s Background Timer) ---
        function mulakanTotalTimer() {
            const initialTime = performance.now();
            
            clearInterval(totalTimeInterval);
            
            totalTimeInterval = setInterval(() => {
                const now = performance.now();
                totalTimeElapsed = (now - initialTime) / 1000;
               
                if (totalTimeElapsed >= QUIZ_DURATION) {
                    tamatkanKuiz(true); 
                }
            }, 100); 
        }

        function hentikanTotalTimer() {
            clearInterval(totalTimeInterval);
        }

        function hentikanTimer() {
             hentikanQuestionTimer();
             hentikanTotalTimer();
        }

        function handleInputSubmission() {
            const inputElement = document.getElementById('answer-input');
            const submitButton = document.querySelector('#input-mode button');
            inputElement.disabled = true;
            submitButton.disabled = true;

            const userAnswer = parseInt(inputElement.value.trim());

            if (isNaN(userAnswer)) {
                inputElement.disabled = false;
                submitButton.disabled = false;
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.textContent = 'Sila masukkan nombor yang sah.';
                feedbackEl.className = 'h-6 text-sm font-semibold text-red-600';
                return;
            }
            semakJawapan(userAnswer);
        }

        function handleInputKey(event) {
            if (event.key === 'Enter') {
                const submitButton = document.querySelector('#input-mode button');
                if (!submitButton.disabled) {
                    handleInputSubmission();
                }
            }
        }

        function handleObjectiveSubmission(button) {
            const userAnswer = parseInt(button.getAttribute('data-value'));

            document.querySelectorAll('.objective-btn').forEach(btn => btn.disabled = true);
            
            semakJawapan(userAnswer, button);
        }


        function semakJawapan(userAnswer, selectedButton = null, isTimeout = false) {
            
            hentikanQuestionTimer(); 
            
            const q = questions[currentQIndex];
            
            const timeTaken = isTimeout ? questionDuration : (questionDuration - qTimeLeft); 
            q.time = timeTaken; 
            q.answered = true;

            const feedbackEl = document.getElementById('feedback');
            const correctAnswer = q.answer;
            let isCorrect = false;

            if (isTimeout) {
                feedbackEl.textContent = `‚è±Ô∏è Masa Tamat! Jawapan ialah ${correctAnswer}.`;
                feedbackEl.className = 'h-6 text-sm font-semibold text-red-600';
                playIncorrectSound();
            } else if (userAnswer === correctAnswer) {
                score++;
                isCorrect = true;
                feedbackEl.textContent = '‚úÖ Betul!';
                feedbackEl.className = 'h-6 text-sm font-semibold text-lime-600'; 
                playCorrectSound(); 
            } else {
                feedbackEl.textContent = `‚ùå Salah. Jawapan ialah ${correctAnswer}.`;
                feedbackEl.className = 'h-6 text-sm font-semibold text-red-600';
                playIncorrectSound(); 
            }

            if (currentMode === 'objective') {
                document.querySelectorAll('.objective-btn').forEach(btn => {
                    const value = parseInt(btn.getAttribute('data-value'));
                    btn.classList.remove('bg-teal-500', 'hover:bg-teal-600');
                    if (value === correctAnswer) {
                        btn.classList.add('bg-pink-600'); 
                    } else if (btn === selectedButton && !isCorrect) {
                        btn.classList.add('bg-red-600'); 
                    } else {
                         btn.classList.add('bg-teal-700'); 
                    }
                });
            }


            currentQIndex++;
            
            const progressPercent = (currentQIndex / totalQuestions) * 100; 
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;

            setTimeout(() => {
                if (currentMode === 'input') {
                    document.getElementById('answer-input').disabled = false;
                    document.querySelector('#input-mode button').disabled = false;
                }
                paparSoalan();
            }, 700);
        }
        
        // -----------------------------------------------------------------
        // FUNGSI PENGUMUMAN KEPUTUSAN KUIZ (Audio Sijil)
        // -----------------------------------------------------------------
        function announceResults(score, finalTP, tpLabel) {
            if (!isTTSEnabled) return; // SEMAKAN TTS
            let resultMessage = "";
            
            // Hanya umumkan TP untuk kuiz gabungan (TP > 0)
            if (finalTP > 0) { 
                if (finalTP >= 5) {
                    resultMessage = "TAHNIAH! Keputusan cemerlang! Anda memang bijak sifir dan sangat pantas! Anda mencapai Tahap Penguasaan lima ke atas!";
                } else if (finalTP >= 3) {
                    resultMessage = "Hebat! Anda telah menguasai sifir. Sila teruskan latihan untuk mencapai Tahap Penguasaan yang lebih tinggi.";
                } else {
                    resultMessage = "Anda telah mencuba. Jangan putus asa, mari cuba kuiz ini sekali lagi untuk tingkatkan markah dan kepantasan anda!";
                }
                const fullAnnouncement = `${resultMessage} Tahap Penguasaan anda adalah TP ${finalTP}. ${tpLabel}.`;
                speakMalay(fullAnnouncement);
            } else {
                // Untuk kuiz sifir tunggal (tanpa TP)
                 if (score / totalQuestions >= 0.9) {
                    resultMessage = "TAHNIAH! Sifir ini sudah dikuasai dengan cemerlang! Mari cuba sifir yang lain.";
                 } else if (score / totalQuestions >= 0.7) {
                    resultMessage = "Bagus! Anda hampir menguasai sifir ini. Sedikit lagi ulangkaji pasti akan menjadikan anda lebih mahir!";
                 } else {
                    resultMessage = "Teruskan latihan untuk sifir ini. Saya yakin anda boleh buat!";
                 }
                 speakMalay(resultMessage);
            }
        }
        // -----------------------------------------------------------------

        // Fungsi Papar Sijil
        function displayCertificate(finalPercentage, finalTP, avgTime, quizTitle) {
            if (!studentName.trim()) {
                // Gunakan alert() kerana ini adalah amaran UI kritikal dan pengguna sudah login
                alert('Sila masukkan nama pelajar untuk menjana sijil.');
                return;
            }
            
            // *** KOD AMARAN BARU DI SINI ***
            if (isMobileInAppBrowser()) {
                const message = 
                    "‚ö†Ô∏è PERHATIAN: Anda mungkin menggunakan Pelayar Dalaman (seperti dalam WhatsApp, Facebook, dsb.). " +
                    "Sila SALIN PAUTAN INI dan BUKA SECARA LANGSUNG di aplikasi Pelayar Penuh " +
                    "(Contoh: CHROME, SAFARI, FIREFOX, EDGE) untuk " +
                    "mencetak/menyimpan sijil sebagai PDF dengan lancar. " +
                    "Jika anda teruskan, terdapat risiko sijil gagal dicetak/disimpan.";
                    
                // Guna 'confirm' untuk memberi pilihan kepada pengguna untuk teruskan
                if (!confirm(message)) {
                    return; // Hentikan proses cetakan jika pengguna memilih 'Cancel'
                }
            }
            // *** AKHIR KOD AMARAN BARU ***

            // Isikan data ke template sijil
            document.getElementById('cert-student-name').textContent = studentName.toUpperCase();
            document.getElementById('cert-quiz-title').textContent = quizTitle;
            document.getElementById('cert-tp').textContent = `TP${finalTP}`;
            document.getElementById('cert-score').textContent = `${finalPercentage.toFixed(1)}%`;
            document.getElementById('cert-avg-time').textContent = avgTime.toFixed(2);
            
            // Tarikh Hari Ini
            const today = new Date();
            document.getElementById('cert-date').textContent = today.toLocaleDateString('ms-MY', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });

            // Tukar paparan
            document.getElementById('quiz-container-wrapper').classList.add('hidden');
            document.getElementById('certificate-screen').classList.remove('hidden');
            document.getElementById('certificate-screen').classList.add('flex'); // Untuk centering
            
            // Pilihan: Umumkan sijil
            speakMalay(`Tahniah ${studentName}! Sijil anda sedia untuk dicetak. Anda mencapai Tahap Penguasaan ${finalTP} dengan skor ${finalPercentage.toFixed(0)} peratus.`);
        }

        function closeCertificate() {
            // Butang cetak sementara di skrin keputusan
            const oldCertButton = document.getElementById('print-certificate-button');
            if (oldCertButton) {
                // ** PEMBETULAN: Buang butang sepenuhnya dari DOM untuk membolehkan ia dijana semula **
                oldCertButton.remove(); 
            }
            
            document.getElementById('certificate-screen').classList.add('hidden');
            document.getElementById('certificate-screen').classList.remove('flex');
            document.getElementById('quiz-container-wrapper').classList.remove('hidden');
            showScreen('result-screen'); // Kembali ke skrin keputusan
        }
        // END NEW: Fungsi Papar Sijil

        // >>> LOGIK TP BARU MENGIKUT KRITERIA PERATUSAN (Hanya untuk Sifir Gabungan 50 Soalan)
        function getTPDetails(accuracy, timeElapsed, totalAnswered) {
            
            if (!isCombinedQuiz) {
                return { finalTP: 0, tpLabel: "Tiada", tpDescription: "Tiada penilaian TP untuk kuiz sifir tunggal.", avgTime: 0 };
            }
            
            let finalTP = 1;
            let tpLabel = "Tahu (Asas)";
            let tpDescription = "Tahu fakta asas sifir, tetapi peratusan jawapan betul kurang daripada 60%. Murid memerlukan bimbingan intensif dan ulangkaji konsep.";
            
            const finalPercentage = (accuracy * 100);
            const avgTime = totalAnswered > 0 ? timeElapsed / totalAnswered : 999;
            const durationLimit = currentMode === 'input' ? 10 : 7; // Had masa soalan 7s/10s
            
            // Kriteria Kelajuan (Berbanding had 7s/10s)
            const veryFast = durationLimit * 0.5; // Contoh: 3.5s (Objektif) atau 5.0s (Input)
            const fast = durationLimit * 0.7;     // Contoh: 4.9s (Objektif) atau 7.0s (Input)
            
            // === TP 1, 2, 3 (Berdasarkan Kriteria Peratusan) ===
            
            if (finalPercentage >= 90) { 
                 // 90% - 100% (45-50 soalan betul)
                 finalTP = 3;
                 tpLabel = "Boleh Buat (Tepat)";
                 tpDescription = `Skor di antara 90% - 100% jawapan betul. Murid boleh mengira fakta sifir dengan **tepat** dan **konsisten** dalam situasi rutin.`;
            } else if (finalPercentage >= 80) {
                 // 80% - 89% (40-44 soalan betul)
                 finalTP = 3;
                 tpLabel = "Boleh Buat (Asas)";
                 tpDescription = `Skor di antara 80% - 89% jawapan betul. Murid boleh mengira fakta sifir dengan **tepat** tetapi mungkin masih lambat sedikit.`;
            } else if (finalPercentage >= 60) {
                 // 60% - 79%
                 finalTP = 2;
                 tpLabel = "Tahu dan Faham (Konsep)";
                 tpDescription = "Skor di antara 60% - 79% jawapan betul. Murid memahami konsep darab tetapi masih melakukan kesilapan pada fakta sifir yang lebih sukar. Perlu latihan fokus.";
            } else {
                 // Kurang dari 60%
                 finalTP = 1;
                 // Penerangan TP1 sudah ditetapkan di atas
            }

            // === Penyesuaian TP 4, 5, 6 (Berpandukan TP3 Tepat/Asas dan Kelajuan) ===
            if (finalPercentage >= 90) { // Hanya tingkatkan TP jika TP3 Tepat dicapai
                 if (avgTime <= veryFast && finalPercentage >= 98) { // Sangat Pantas & Hampir Sempurna (49-50 Betul)
                    finalTP = 6;
                    tpLabel = "Cemerlang & Sangat Pantas (Fluent)";
                    tpDescription = `Menguasai sifir dengan cermat, tepat (skor 98%+), cekap, dan **sangat pantas** (Purata Masa **< ${veryFast.toFixed(1)}s**). SANGAT DISYORKAN UNTUK LATIHAN LANJUTAN!`;
                } else if (avgTime <= veryFast) { // Pantas & Tepat
                    finalTP = 5;
                    tpLabel = "Sangat Mahir & Pantas";
                    tpDescription = `Melaksanakan kemahiran sifir dengan cermat, tepat (skor 90%+), cekap, dan **pantas** (Purata Masa **< ${veryFast.toFixed(1)}s**). Boleh beralih ke kuiz yang lebih kompleks.`;
                } else if (avgTime <= fast) { // Cekap Masa (Selesai dalam had)
                    finalTP = 4;
                    tpLabel = "Mahir & Cekap Masa";
                    tpDescription = `Melaksanakan kemahiran sifir dengan cekap dan tepat dalam had masa kuiz (Purata Masa **< ${fast.toFixed(1)}s**).`;
                }
                // Jika peratusan 90%+ tetapi masa purata > fast, ia kekal di TP3 Tepat.
            } else if (finalPercentage >= 80 && avgTime <= fast) {
                 // Jika 80-89% dan cekap masa, ia kekal di TP3 Asas.
                 finalTP = 3; 
            }
            
            return { finalTP, tpLabel, tpDescription, avgTime };
        }

        function tamatkanKuiz(isTotalTimeout = false) {
            hentikanTimer(); 

            const answeredQuestions = questions.slice(0, currentQIndex);
            const totalAnswered = answeredQuestions.length;
            const totalTimeTaken = answeredQuestions.reduce((sum, q) => sum + q.time, 0);

            const scorePercent = (score / totalQuestions);
            
            const finalPercentage = (score / totalQuestions) * 100;
            const incorrectCount = totalAnswered - score;

            let finalTP = 0; 
            let tpLabel = "";
            let tpMessage = "";
            let tpDescription = "";
            let modeText = currentMode === 'objective' ? 'Objektif' : 'Input';
            let totalScore = score;
            let avgTime = totalAnswered > 0 ? totalTimeTaken / totalAnswered : 0;
            
            let tpDetails = null;

            // --- Logik Tajuk Kuiz Di Skrin Keputusan ---
            let quizTitleDisplay = '';
            let certQuizTitle = ''; // Tajuk untuk Sijil
            if (currentSifir === 0) {
                 document.getElementById('quiz-result-title').querySelector('h2').textContent = 'Kuiz Bijak Sifir';
                 quizTitleDisplay = `(1-12) Gabungan - ${modeText}`;
                 certQuizTitle = `Kuiz Bijak Sifir Gabungan (1-12) ${modeText}`;
            } else {
                 document.getElementById('quiz-result-title').querySelector('h2').textContent = 'Kuiz Bijak Sifir';
                 quizTitleDisplay = `Sifir ${currentSifir} - ${modeText}`;
                 certQuizTitle = `Kuiz Sifir ${currentSifir} (Tunggal) ${modeText}`;
            }
            document.getElementById('sifir-title-display').textContent = quizTitleDisplay;
            // --- Akhir Logik Tajuk Kuiz ---
            
            // --- Logik Paparan TP ---
            const tpGroupEl = document.getElementById('tp-display-group');
            if (isCombinedQuiz) {
                tpGroupEl.classList.remove('tp-hidden');
            } else {
                tpGroupEl.classList.add('tp-hidden');
            }
            // --- Akhir Logik Paparan TP ---


            if (isTotalTimeout) {
                tpMessage = `‚ùå Had Masa Keseluruhan (250s) Kuiz ${modeText} Tamat! Kuiz terhenti pada soalan ${currentQIndex} dari ${totalQuestions}.`;
                
                if (isCombinedQuiz) {
                    // Gunakan logik TP asas untuk kuiz gabungan yang terhenti
                    const partialAccuracy = score / totalAnswered;
                    if (partialAccuracy >= 0.8) {
                        finalTP = 3; tpLabel = "Boleh Buat (Terhenti)"; tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Anda tepat, tetapi perlu tingkatkan fokus untuk menyiapkan kuiz.";
                    } else if (partialAccuracy >= 0.6) {
                        finalTP = 2; tpLabel = "Faham (Terhenti)"; tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Anda faham konsep, tetapi perlu tingkatkan kelajuan menjawab dan ketepatan.";
                    } else {
                        finalTP = 1; tpLabel = "Tahu (Terhenti)"; tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Perlu ulangkaji fakta sifir anda dengan lebih tekun.";
                    }
                } else {
                    tpMessage = `‚ùå Had Masa Kuiz ${modeText} Tamat.`;
                }
                
                announceResults(totalScore, finalTP, tpLabel);

            } else {
                tpDetails = getTPDetails(scorePercent, totalTimeTaken, totalAnswered);
                finalTP = tpDetails.finalTP;
                tpLabel = tpDetails.tpLabel;
                tpDescription = tpDetails.tpDescription;
                
                if (isCombinedQuiz) {
                    tpMessage = `üéâ Tahniah! Anda menyelesaikan Kuiz ${modeText} ini dengan jayanya.`;
                } else {
                    tpMessage = `üéâ Kuiz Sifir ${currentSifir} Selesai!`;
                }
                
                avgTime = tpDetails.avgTime;
                
                announceResults(totalScore, finalTP, tpLabel);
            }
            
            showScreen('result-screen');
            
            // Memaparkan nama pelajar
            document.getElementById('student-result-name').textContent = studentName || 'PELAJAR'; 

            // Hanya paparkan TP jika ia kuiz gabungan (isCombinedQuiz)
            if (isCombinedQuiz) {
                document.getElementById('final-tp').textContent = `TP${finalTP}`;
                document.getElementById('tp-label').textContent = tpLabel;
                document.getElementById('tp-description').textContent = tpDescription;
                document.getElementById('main-tp-message').textContent = tpMessage; // Mesej utama di bawah nama
            } else {
                 document.getElementById('main-tp-message').textContent = tpMessage; // Mesej keputusan sahaja untuk sifir tunggal
            }

            document.getElementById('final-score').textContent = `${totalScore} / ${totalQuestions}`;
            document.getElementById('final-percentage').textContent = `${finalPercentage.toFixed(1)}%`;

            document.getElementById('correct-count').textContent = totalScore;
            document.getElementById('incorrect-count').textContent = incorrectCount; 
            document.getElementById('average-time').textContent = avgTime.toFixed(2);
            
            // Logik Butang Cetak Sijil
            const certButtonId = 'print-certificate-button';
            let certButton = document.getElementById(certButtonId);
            
            if (isCombinedQuiz && !isTotalTimeout) { 
                if (!certButton) {
                    // Tambah butang jika belum wujud (diletakkan sebelum butang Ulang Kuiz)
                    certButton = document.createElement('button');
                    certButton.id = certButtonId;
                    certButton.className = 'w-full bg-lime-500 hover:bg-lime-600 text-white font-black text-base py-3 rounded-lg transition duration-150 shadow-lg hover:shadow-xl mt-3';
                    const repeatButton = document.querySelector('#result-screen button:last-child');
                    document.getElementById('result-screen').insertBefore(certButton, repeatButton);
                }
                certButton.textContent = 'üèÖ Cetak Sijil Penghargaan';
                certButton.onclick = () => displayCertificate(finalPercentage, finalTP, avgTime, certQuizTitle);

                // Paparkan butang di sini
                certButton.classList.remove('hidden');
            } else if (certButton) {
                // Sembunyikan butang jika bukan kuiz gabungan atau tamat masa
                 certButton.classList.add('hidden');
            }
            // END NEW: Logik Butang Cetak Sijil
        }
    </script>
</body>

</html>

