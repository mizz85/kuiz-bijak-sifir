<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Bijak Sifir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
<style>
    /* Menggunakan font-family yang lebih sesuai untuk paparan sifar */
    .font-sifir {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }

    /* --- PENTING: Pembetulan Cetak Sijil HP (Blank PDF Issue) --- */
    @media print {
        /* Memastikan warna latar belakang dan teks dicetak */
        * {
            -webkit-print-color-adjust: exact !important; /* Untuk Chrome/Android/iOS */
            color-adjust: exact !important; /* Untuk Firefox */
        }
        
        /* 1. Sembunyikan semua kecuali skrin sijil */
        body > *:not(#certificate-screen) {
            display: none !important;
        }

        /* 2. Tetapkan Body dan HTML untuk paparan penuh dan stabil */
        html, body {
            height: auto !important;
            min-height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            display: block !important; 
        }

        /* 3. Paksa Kontena Sijil untuk dipaparkan secara blok stabil */
        #certificate-screen {
            display: block !important;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 0;
        }

        /* 4. Sembunyikan elemen yang tidak diperlukan dalam cetakan sijil */
        .no-print {
            display: none !important;
        }
    }

    /* --- Pembetulan Cetak Mudah Alih (Mobile Print Fix) --- */
    /* Sembunyikan butang "Cetak ke PDF" dan tunjukkan notis amaran pada skrin kecil */
    @media screen and (max-width: 767px) {
        /* Butang "Cetak ke PDF" di dalam Sijil: Akan disembunyikan */
        .mobile-print-button-hide { 
            display: none !important;
        }

        /* Notis Amaran di dalam Sijil: Akan dipaparkan */
        #mobile-print-warning {
            display: block !important;
            background-color: #fef08a; /* Kuning Lembut */
            color: #854a04; /* Teks coklat gelap */
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 15px;
        }
    }

    /* Sembunyikan notis amaran secara lalai (Desktop) */
    #mobile-print-warning {
        display: none;
    }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="quiz-container-wrapper" class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 md:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-blue-600">Kuiz Bijak Sifir</h1>
            <p class="text-gray-500">Uji kefahaman sifir anda.</p>
        </header>

        <div id="selection-screen" class="space-y-6">
            <div class="space-y-3">
                <label for="student-name" class="block text-lg font-medium text-gray-700">Nama Pelajar:</label>
                <input type="text" id="student-name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama anda">
            </div>

            <h2 class="text-xl font-bold text-gray-700">Pilih Sifir (1 hingga 12):</h2>
            <div id="sifir-selection" class="grid grid-cols-4 sm:grid-cols-6 gap-3">
                </div>
            <p class="text-sm text-gray-500 mt-2">Pilih satu atau lebih sifir untuk dimulakan.</p>

            <h2 class="text-xl font-bold text-gray-700">Pilih Jenis Kuiz:</h2>
            <div class="flex flex-col space-y-3 sm:flex-row sm:space-x-4 sm:space-y-0">
                <button onclick="startQuiz('objective')" class="flex-1 p-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition duration-150">
                    Pilihan Jawapan (Objektif)
                </button>
                <button onclick="startQuiz('input')" class="flex-1 p-4 bg-purple-500 text-white font-bold rounded-lg shadow-md hover:bg-purple-600 transition duration-150">
                    Input Jawapan
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <p id="question-counter" class="text-xl font-bold text-blue-600">Soalan 1/50</p>
                <p id="timer-display" class="text-xl font-bold text-red-500">Masa: 0.0s</p>
            </div>

            <div class="text-center bg-blue-50 p-6 rounded-xl border-4 border-blue-200">
                <h2 id="question-text" class="text-4xl font-extrabold text-gray-800 font-sifir"></h2>
            </div>
            
            <div id="objective-answers" class="grid grid-cols-2 gap-4 hidden">
                </div>

            <div id="input-answer" class="space-y-4 hidden">
                <input type="number" id="answer-input" class="w-full p-4 text-center text-3xl border-4 border-gray-300 rounded-lg shadow-inner focus:ring-purple-500 focus:border-purple-500 font-sifir" placeholder="Jawapan" onkeydown="handleInputKey(event)">
                <button onclick="submitAnswer()" class="w-full p-4 bg-purple-500 text-white text-xl font-bold rounded-lg shadow-md hover:bg-purple-600 transition duration-150">
                    Sahkan Jawapan
                </button>
            </div>

            <p id="feedback-message" class="text-center text-lg font-bold min-h-[1.5em]"></p>
        </div>

        <div id="result-screen" class="hidden text-center space-y-4">
            <h2 id="main-tp-message" class="text-2xl font-extrabold text-green-700"></h2>
            <p class="text-lg font-semibold text-gray-700">Nama: <span id="student-name-result" class="font-extrabold text-blue-600"></span></p>

            <div class="grid grid-cols-2 gap-4 text-left">
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <p class="text-sm text-gray-500">Markah</p>
                    <p id="final-score" class="text-3xl font-extrabold text-red-500">0 / 50</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <p class="text-sm text-gray-500">Peratus</p>
                    <p id="final-percentage" class="text-3xl font-extrabold text-red-500">0%</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border col-span-2">
                    <p class="text-sm text-gray-500">Tahap Penguasaan (TP)</p>
                    <p class="text-4xl font-extrabold text-yellow-600"><span id="final-tp">TP1</span>: <span id="tp-label">Tahu</span></p>
                    <p id="tp-description" class="text-sm mt-1 italic text-gray-600"></p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 text-sm text-gray-700 font-semibold mt-4">
                <p class="text-green-600">‚úÖ Betul: <span id="correct-count">0</span></p>
                <p class="text-red-600">‚ùå Salah: <span id="incorrect-count">0</span></p>
                <p class="text-blue-600">‚è±Ô∏è Purata Masa: <span id="average-time">0.00</span>s</p>
            </div>
            
            <div class="p-4 bg-teal-50 rounded-xl border border-teal-300 mt-6">
                <h3 class="text-xl font-bold text-teal-700 mb-4 text-center">Sejarah Kuiz</h3>
                
                <div id="history-container">
                    </div>
            </div>
            <div class="flex flex-col space-y-3 mt-6">
                <button onclick="displayCertificateForPrint()" id="print-certificate-btn" class="p-3 bg-pink-500 text-white font-bold rounded-lg shadow-md hover:bg-pink-600 transition duration-150">
                    Cetak / Simpan Sijil Pencapaian
                </button>
                <button onclick="startNewQuizSelection()" class="p-3 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition duration-150">
                    Ulang Kuiz (Pilihan Sifir)
                </button>
            </div>
        </div>

    </div>

    <div id="certificate-screen" class="hidden fixed inset-0 bg-white z-50 overflow-auto p-4">
        </div>

    <script>
        let selectedSifirs = [];
        let questions = [];
        let currentQIndex = 0;
        let score = 0;
        let timer;
        let startTime;
        let currentMode = 'objective';
        let totalTimeLimit = 250; // 250 saat untuk 50 soalan

        // --- GLOBAL FUNCTIONS AND INITIALIZATION ---

        function initSifirSelection() {
            const container = document.getElementById('sifir-selection');
            container.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'p-3 bg-gray-200 text-gray-800 font-bold rounded-lg shadow-sm hover:bg-gray-300 transition duration-150';
                btn.setAttribute('data-sifir', i);
                btn.onclick = function() { toggleSifir(i, btn); };
                container.appendChild(btn);
            }
        }

        function toggleSifir(sifir, btn) {
            const index = selectedSifirs.indexOf(sifir);
            if (index > -1) {
                selectedSifirs.splice(index, 1);
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            } else {
                selectedSifirs.push(sifir);
                btn.classList.remove('bg-gray-200', 'text-gray-800');
                btn.classList.add('bg-blue-500', 'text-white');
            }
        }

        function showScreen(screenId) {
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('certificate-screen').classList.add('hidden');

            document.getElementById(screenId).classList.remove('hidden');
            
            // Jika masuk ke skrin keputusan, pastikan nama diisi.
            if (screenId === 'result-screen') {
                const studentName = document.getElementById('student-name').value || 'Pelajar Tanpa Nama';
                document.getElementById('student-name-result').textContent = studentName;
            }
        }

        // --- TIMER AND UI FUNCTIONS ---

        function mulakanTimer() {
            startTime = Date.now();
            updateTimer();
            timer = setInterval(updateTimer, 100);
        }

        function hentikanTimer() {
            clearInterval(timer);
        }

        function updateTimer() {
            const elapsedSeconds = (Date.now() - startTime) / 1000;
            document.getElementById('timer-display').textContent = `Masa: ${elapsedSeconds.toFixed(1)}s`;
            
            if (elapsedSeconds >= totalTimeLimit && currentQIndex < 50) {
                 hentikanTimer();
                 tamatkanKuiz(true); // Masa tamat
            }
        }

        function announceResults(score, tp, label) {
            // (Kod TTS/Audio anda akan berada di sini. Dibiarkan kosong untuk keprluan GitHub)
            // Cth: speakMalay(`Tahniah! Skor ${score} dengan Tahap Penguasaan ${label}.`);
        }

        // --- QUESTION GENERATION AND HANDLING ---

        function generateQuestions() {
            if (selectedSifirs.length === 0) {
                alert("Sila pilih sekurang-kurangnya satu sifir (1-12) untuk dimulakan.");
                return false;
            }

            questions = [];
            let pool = [];

            // Isi pool dengan semua soalan yang mungkin berdasarkan sifir yang dipilih (cth: 5x1 hingga 5x12)
            selectedSifirs.forEach(sifir => {
                for (let i = 1; i <= 12; i++) {
                    pool.push({ num1: sifir, num2: i, answer: sifir * i });
                }
            });

            // Randomly pilih 50 soalan dari pool (atau ulangi jika pool < 50)
            for (let i = 0; i < 50; i++) {
                const randomIndex = Math.floor(Math.random() * pool.length);
                const question = { ...pool[randomIndex], startTime: null, time: 0 };
                questions.push(question);
            }

            // Jika objektif, sediakan pilihan jawapan
            if (currentMode === 'objective') {
                questions.forEach(q => {
                    q.options = generateOptions(q.answer);
                });
            }

            return true;
        }

        function generateOptions(correctAnswer) {
            const options = new Set();
            options.add(correctAnswer);

            while (options.size < 4) {
                let dist;
                if (correctAnswer < 10) {
                    dist = Math.floor(Math.random() * 5) + 1; // Jarak dekat
                } else if (correctAnswer < 50) {
                    dist = Math.floor(Math.random() * 10) + 1; // Jarak sederhana
                } else {
                    dist = Math.floor(Math.random() * 20) + 1; // Jarak jauh
                }
                
                let randomAnswer;
                if (Math.random() < 0.5) {
                    randomAnswer = correctAnswer + dist;
                } else {
                    randomAnswer = correctAnswer - dist;
                }

                if (randomAnswer > 0 && randomAnswer !== correctAnswer) {
                    options.add(randomAnswer);
                }
            }

            return Array.from(options).sort(() => Math.random() - 0.5);
        }
        
        // --- START QUIZ ---

        function startQuiz(mode) {
            const studentName = document.getElementById('student-name').value;
            if (!studentName || studentName.trim() === '') {
                alert("Sila masukkan Nama Pelajar untuk memulakan kuiz.");
                document.getElementById('student-name').focus();
                return;
            }
            
            currentMode = mode;

            if (!generateQuestions()) return;

            // Simpan nama pelajar semasa ke localStorage untuk kegunaan lain
            localStorage.setItem('studentName', studentName.trim());
            
            // Reset state
            currentQIndex = 0;
            score = 0;
            
            // Sediakan UI berdasarkan mode
            if (mode === 'objective') {
                document.getElementById('objective-answers').classList.remove('hidden');
                document.getElementById('input-answer').classList.add('hidden');
            } else {
                document.getElementById('objective-answers').classList.add('hidden');
                document.getElementById('input-answer').classList.remove('hidden');
            }

            showScreen('quiz-screen');
            mulakanTimer();
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQIndex >= questions.length) {
                tamatkanKuiz(false);
                return;
            }

            const q = questions[currentQIndex];
            q.startTime = Date.now();
            document.getElementById('question-counter').textContent = `Soalan ${currentQIndex + 1}/50`;
            document.getElementById('question-text').textContent = `${q.num1} X ${q.num2} = ?`;
            document.getElementById('feedback-message').textContent = '';

            if (currentMode === 'objective') {
                displayObjectiveOptions(q.options, q.answer);
            } else {
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
            }
        }

        function displayObjectiveOptions(options, correctAnswer) {
            const container = document.getElementById('objective-answers');
            container.innerHTML = '';
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.textContent = option;
                btn.className = 'p-4 bg-gray-200 text-gray-800 text-2xl font-bold rounded-lg shadow-md hover:bg-gray-300 transition duration-150 font-sifir';
                btn.onclick = function() { submitAnswer(option, correctAnswer, btn); };
                container.appendChild(btn);
            });
        }

        // --- SUBMIT ANSWER ---

        function submitAnswer(selectedOption, correctAnswer, btn) {
            const q = questions[currentQIndex];
            q.time = (Date.now() - q.startTime) / 1000;
            
            let isCorrect;
            let userAnswer;
            
            if (currentMode === 'objective') {
                userAnswer = selectedOption;
                isCorrect = (userAnswer === correctAnswer);
            } else {
                userAnswer = parseInt(document.getElementById('answer-input').value);
                isCorrect = (userAnswer === q.answer);
            }

            q.isCorrect = isCorrect;

            if (isCorrect) {
                score++;
                document.getElementById('feedback-message').textContent = "‚úÖ BETUL!";
                document.getElementById('feedback-message').classList.remove('text-red-500');
                document.getElementById('feedback-message').classList.add('text-green-500');
            } else {
                document.getElementById('feedback-message').textContent = `‚ùå SALAH. Jawapan yang betul: ${q.answer}`;
                document.getElementById('feedback-message').classList.remove('text-green-500');
                document.getElementById('feedback-message').classList.add('text-red-500');
            }

            // Disable buttons/input buat sementara waktu
            if (currentMode === 'objective') {
                document.querySelectorAll('#objective-answers button').forEach(b => b.disabled = true);
                if (isCorrect) {
                     btn.classList.add('bg-green-500', 'text-white');
                } else {
                     btn.classList.add('bg-red-500', 'text-white');
                     // Highlight jawapan betul
                     document.querySelectorAll('#objective-answers button').forEach(b => {
                        if (parseInt(b.textContent) === correctAnswer) {
                            b.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                            b.classList.add('bg-green-300');
                        }
                    });
                }
            } else {
                document.getElementById('answer-input').disabled = true;
                document.querySelector('#input-answer button').disabled = true;
                if (isCorrect) {
                    document.getElementById('answer-input').classList.add('bg-green-100');
                } else {
                    document.getElementById('answer-input').classList.add('bg-red-100');
                }
            }
            
            // Bergerak ke soalan seterusnya selepas delay
            setTimeout(() => {
                if (currentMode === 'objective') {
                    document.querySelectorAll('#objective-answers button').forEach(b => b.disabled = false);
                } else {
                    document.getElementById('answer-input').disabled = false;
                    document.querySelector('#input-answer button').disabled = false;
                    document.getElementById('answer-input').classList.remove('bg-green-100', 'bg-red-100');
                }

                currentQIndex++;
                displayQuestion();
            }, 1500);
        }
        
        function handleInputKey(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        }

        // --- TAMAT KUIZ DAN KIRA TP ---

        function getTPDetails(accuracy, totalTimeTaken, totalAnswered) {
            const avgTime = totalAnswered > 0 ? totalTimeTaken / totalAnswered : 0;
            let finalTP = 1;
            let tpLabel = "Tahu";
            let tpDescription = "Anda perlu mengulangkaji fakta asas sifir dengan lebih mendalam dan teliti.";
            
            // TP 6
            if (accuracy >= 0.95 && avgTime <= 2.5) {
                finalTP = 6;
                tpLabel = "Cemerlang & Pantas";
                tpDescription = "Tahniah! Anda menguasai semua sifir dengan sangat pantas dan tepat. Boleh membimbing rakan sebaya.";
            } 
            // TP 5
            else if (accuracy >= 0.9 && avgTime <= 3.5) {
                finalTP = 5;
                tpLabel = "Mahir";
                tpDescription = "Sangat bagus! Anda menguasai sifir dengan baik. Teruskan latihan untuk kekalkan kelajuan dan ketepatan.";
            }
            // TP 4
            else if (accuracy >= 0.8 && avgTime <= 5) {
                finalTP = 4;
                tpLabel = "Boleh Menganalisa";
                tpDescription = "Baik! Anda tahu dan faham sifir. Tumpukan perhatian untuk meningkatkan kelajuan menjawab.";
            }
            // TP 3
            else if (accuracy >= 0.7) {
                finalTP = 3;
                tpLabel = "Boleh Mengaplikasi";
                tpDescription = "Anda boleh mengaplikasi konsep sifir, tetapi masih ada ruang untuk meningkatkan ketepatan dan kelajuan.";
            }
            // TP 2
            else if (accuracy >= 0.4) {
                finalTP = 2;
                tpLabel = "Faham";
                tpDescription = "Anda faham konsep sifir, tetapi perlu mengulang kaji fakta asas untuk meningkatkan markah.";
            }
            // TP 1 kekal jika < 0.4

            return { finalTP, tpLabel, tpDescription, avgTime };
        }

        function tamatkanKuiz(isTotalTimeout = false) {
            hentikanTimer(); 

            const answeredQuestions = questions.slice(0, currentQIndex);
            const totalAnswered = answeredQuestions.length;
            const totalTimeTaken = answeredQuestions.reduce((sum, q) => sum + q.time, 0);

            const accuracy = score / 50;
            
            const finalPercentage = (score / 50) * 100;
            const incorrectCount = totalAnswered - score;

            let finalTP = 1;
            let tpLabel = "";
            let tpMessage = "";
            let tpDescription = "";
            let modeText = currentMode === 'objective' ? 'Objektif' : 'Input';
            let totalScore = score;
            let avgTime = 0;
            const studentName = document.getElementById('student-name').value; // Dapatkan nama di sini

            if (isTotalTimeout) {
                tpMessage = `‚ùå Had Masa Keseluruhan (${totalTimeLimit}s) Kuiz ${modeText} Tamat! Kuiz terhenti pada soalan ${currentQIndex} dari 50.`;
                const partialAccuracy = score / totalAnswered;
                    if (partialAccuracy >= 0.7) {
                    finalTP = 3;
                    tpLabel = "Boleh Mengaplikasi";
                    tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Anda boleh mengaplikasi, tetapi perlukan latihan fokus dan ketepatan masa.";
                } else if (partialAccuracy >= 0.4) {
                    finalTP = 2;
                    tpLabel = "Faham";
                    tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Anda faham konsep, tetapi perlu tingkatkan kelajuan menjawab.";
                } else {
                    finalTP = 1;
                    tpLabel = "Tahu";
                    tpDescription = "Kuiz terhenti kerana masa keseluruhan tamat. Perlu ulangkaji fakta sifir anda dengan lebih tekun.";
                }
                avgTime = totalAnswered > 0 ? totalTimeTaken / totalAnswered : 0;
                
                announceResults(totalScore, finalTP, tpLabel);

            } else {
                const tpDetails = getTPDetails(accuracy, totalTimeTaken, totalAnswered);
                finalTP = tpDetails.finalTP;
                tpLabel = tpDetails.tpLabel;
                tpDescription = tpDetails.tpDescription;
                tpMessage = `üéâ Tahniah! Anda menyelesaikan Kuiz ${modeText} ini dengan jayanya.`;
                avgTime = tpDetails.avgTime;
                
                announceResults(totalScore, finalTP, tpLabel);
                
                // --- SIMPAN SEJARAH SKOR (MENGIKUT NAMA PELAJAR) ---
                saveQuizHistory(finalTP, tpLabel, totalScore, totalTimeTaken, studentName); 
                // -----------------------------------------------------
            }
            
            // --- PAPARKAN SEJARAH SKOR ---
            displayQuizHistory(); 
            // ------------------------------
            
            showScreen('result-screen');

            document.getElementById('final-tp').textContent = `TP${finalTP}`;
            document.getElementById('tp-label').textContent = tpLabel;
            document.getElementById('tp-description').textContent = tpDescription;
            document.getElementById('main-tp-message').textContent = tpMessage;
            
            document.getElementById('final-score').textContent = `${totalScore} / 50`;
            document.getElementById('final-percentage').textContent = `${finalPercentage.toFixed(1)}%`;

            document.getElementById('correct-count').textContent = totalScore;
            document.getElementById('incorrect-count').textContent = incorrectCount; 
            document.getElementById('average-time').textContent = avgTime.toFixed(2);
            
            const printBtn = document.getElementById('print-certificate-btn');
            printBtn.setAttribute('data-tp', finalTP);
            printBtn.setAttribute('data-label', tpLabel);
            printBtn.setAttribute('data-score', totalScore);

        }
        
        function startNewQuizSelection() {
            // Reset sifir buttons di skrin pemilihan
            const sifirButtons = document.querySelectorAll('#sifir-selection button');
            sifirButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });
            selectedSifirs = [];
            
            showScreen('selection-screen');
            speakMalay('Sila masukkan nama dan buat pilihan kuiz baharu.');
        }

        // --- FUNGSI SIJIL DAN CETAK ---
        
        function generateCertificateHTML(name, tp, label, score) {
            const date = new Date().toLocaleDateString('ms-MY', { day: '2-digit', month: 'long', year: 'numeric' });
            
            // Tentukan warna dan ikon berdasarkan TP
            let colorClass, iconHtml;
            if (tp >= 5) {
                colorClass = 'border-yellow-500 bg-yellow-100 text-yellow-800';
                iconHtml = '‚≠ê';
            } else if (tp >= 3) {
                colorClass = 'border-green-500 bg-green-100 text-green-800';
                iconHtml = '‚úÖ';
            } else {
                colorClass = 'border-red-500 bg-red-100 text-red-800';
                iconHtml = 'üìö';
            }

            return `
                <div class="relative min-h-screen flex items-center justify-center p-8">
                    <div class="w-full max-w-4xl border-8 ${colorClass} p-10 md:p-20 shadow-2xl bg-white">
                        <div class="text-center space-y-8">
                            <h1 class="text-5xl font-extrabold text-gray-800">Sijil Pencapaian</h1>
                            <p class="text-xl text-gray-600">Dengan ini disahkan bahawa</p>
                            
                            <h2 class="text-7xl font-black text-blue-600 uppercase tracking-wider">${name}</h2>
                            
                            <p class="text-xl text-gray-600">telah berjaya menyelesaikan Kuiz Bijak Sifir dan mencapai</p>
                            
                            <div class="my-6">
                                <span class="inline-block px-8 py-3 rounded-full text-5xl font-extrabold shadow-lg ${colorClass}">
                                    ${iconHtml} TP${tp}: ${label} ${iconHtml}
                                </span>
                            </div>

                            <p class="text-2xl font-bold text-gray-700">Markah Diperolehi: <span class="text-red-600">${score} / 50</span></p>

                            <p class="text-xl text-gray-600 pt-4">Tarikh Sijil Dikeluarkan: ${date}</p>
                            
                            <div class="no-print text-center mt-8">
                                
                                <div id="mobile-print-warning" style="display:none;">
                                    Sila gunakan **PC/Laptop** untuk Cetak ke PDF. Fungsi cetak di telefon bimbit sering bermasalah.
                                </div>

                                <button onclick="window.print();" class="mobile-print-button-hide bg-pink-500 hover:bg-pink-600 text-white font-medium py-2 px-6 rounded-lg transition duration-150 shadow-md mr-4">
                                    Cetak ke PDF
                                </button>
                                
                                <button onclick="returnFromCertificate()" class="bg-gray-700 hover:bg-gray-800 text-white font-medium py-2 px-6 rounded-lg transition duration-150 shadow-md">
                                    Tutup Sijil & Buat Kuiz Baharu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function returnFromCertificateLogic() {
             // Sembunyikan sijil dan kembali ke skrin keputusan/kuiz
             const certificateScreen = document.getElementById('certificate-screen');
             certificateScreen.classList.add('hidden');
             document.getElementById('quiz-container-wrapper').classList.remove('hidden');
             // Ini akan memastikan ia kembali ke skrin yang paling sesuai (biasanya keputusan)
             if (document.getElementById('result-screen').classList.contains('hidden')) {
                 showScreen('selection-screen'); // Jika tiada keputusan, kembali ke pemilihan
             } else {
                 showScreen('result-screen');
             }
        }

        function displayCertificateForPrint() {
            const printBtn = document.getElementById('print-certificate-btn');
            const name = document.getElementById('student-name-result').textContent;
            const tp = printBtn.getAttribute('data-tp');
            const label = printBtn.getAttribute('data-label');
            const score = printBtn.getAttribute('data-score');
            
            const certificateHTML = generateCertificateHTML(name, tp, label, score);
            
            const certificateScreen = document.getElementById('certificate-screen');
            
            certificateScreen.innerHTML = certificateHTML;
            certificateScreen.classList.remove('hidden');

            document.getElementById('quiz-container-wrapper').classList.add('hidden');
            
            // speakMalay(`Sijil anda telah sedia. Sila cetak atau simpan sebagai PDF.`);
            
            // TRIK MUDAH ALIH:
            // Sediakan mekanisme untuk kembali ke skrin keputusan selepas 3 saat.
            // Ini berfungsi jika pengguna menutup dialog cetak tanpa mencetak.
             setTimeout(function () {
                 returnFromCertificateLogic(); 
             }, 3000); // Beri masa 3 saat untuk pengguna berinteraksi dengan dialog cetak sistem (Save as PDF)
        }

        function returnFromCertificate() {
            // Fungsi ini dipanggil apabila butang "Tutup Sijil & Buat Kuiz Baharu" diklik
            const certificateScreen = document.getElementById('certificate-screen');
            
            certificateScreen.classList.add('hidden');
            
            document.getElementById('quiz-container-wrapper').classList.remove('hidden');
            
            certificateScreen.innerHTML = '';
            
            // Bawa terus ke skrin pemilihan kuiz yang baru
            showScreen('selection-screen');
            // speakMalay('Sila buat pilihan kuiz baharu.');
        }

        // --- LOGIK SEJARAH SKOR PELAJAR ---

        // Kunci utama untuk menyimpan SEMUA data (sejarah + nama pelajar)
        const QUIZ_DATA_STORAGE_KEY = 'kuiz_sifir_all_users_data';
        // MAX_HISTORY_RECORDS kekal 10

        function saveQuizHistory(finalTP, tpLabel, score, totalTimeTaken, studentName) {
            if (!studentName || studentName.trim() === '') return; // Jangan simpan jika tiada nama

            // 1. Muatkan semua data pengguna
            const allUsersDataJson = localStorage.getItem(QUIZ_DATA_STORAGE_KEY);
            let allUsersData = allUsersDataJson ? JSON.parse(allUsersDataJson) : {};
            
            // Pastikan nama pelajar distandardkan (huruf kecil) sebagai kunci
            const userKey = studentName.toLowerCase().trim();

            // 2. Dapatkan sejarah pelajar semasa
            let userHistory = allUsersData[userKey] || [];
            
            // 3. Bina objek rekod baru
            const newRecord = {
                date: new Date().toLocaleDateString('ms-MY', { year: 'numeric', month: '2-digit', day: '2-digit' }),
                time: new Date().toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' }),
                tp: finalTP,
                label: tpLabel,
                score: score,
                totalTime: totalTimeTaken.toFixed(2) + 's' 
            };
            
            // 4. Tambah rekod baru, hadkan, dan simpan kembali
            userHistory.unshift(newRecord);
            if (userHistory.length > MAX_HISTORY_RECORDS) {
                userHistory = userHistory.slice(0, MAX_HISTORY_RECORDS);
            }
            
            // Kemas kini data pengguna dan simpan semula ke localStorage
            allUsersData[userKey] = userHistory;
            localStorage.setItem(QUIZ_DATA_STORAGE_KEY, JSON.stringify(allUsersData));
        }

        function displayQuizHistory(sortBy = 'date', sortOrder = 'desc') {
            // 1. Dapatkan nama pelajar semasa dari input
            const studentName = document.getElementById('student-name').value || 'Pelajar';
            const userKey = studentName.toLowerCase().trim();
            
            // 2. Muatkan data dan dapatkan sejarah untuk pelajar semasa
            const allUsersDataJson = localStorage.getItem(QUIZ_DATA_STORAGE_KEY);
            const allUsersData = allUsersDataJson ? JSON.parse(allUsersDataJson) : {};
            let history = allUsersData[userKey] || [];
            
            const historyContainer = document.getElementById('history-container');
            
            // Jika tiada rekod
            if (history.length === 0) {
                historyContainer.innerHTML = `
                    <div class="flex space-x-2 mb-4 justify-center">
                        <button class="py-1 px-3 text-sm rounded-full bg-gray-200 text-gray-700 disabled:opacity-50" disabled>Markah Tertinggi</button>
                        <button class="py-1 px-3 text-sm rounded-full bg-gray-200 text-gray-700 disabled:opacity-50" disabled>Markah Terendah</button>
                        <button class="py-1 px-3 text-sm rounded-full bg-gray-200 text-gray-700 disabled:opacity-50" disabled>Terkini</button>
                    </div>
                    <p class="text-sm text-gray-500 text-center italic">Tiada rekod kuiz untuk ${studentName}.</p>
                `;
                return;
            }

            // --- LOGIK PENGASINGAN (SORTING LOGIC) ---
            history.sort((a, b) => {
                let comparison = 0;
                
                if (sortBy === 'score') {
                    comparison = a.score - b.score; 
                } else if (sortBy === 'tp') {
                    comparison = a.tp - b.tp;
                } else {
                    // Lalai: Mengasingkan berdasarkan tarikh/masa (Terkini)
                    const dateA = new Date(a.date.split('/').reverse().join('-') + ' ' + a.time);
                    const dateB = new Date(b.date.split('/').reverse().join('-') + ' ' + b.time);
                    comparison = dateA - dateB;
                }

                // Balikkan susunan jika order adalah 'desc' (Tertinggi / Terkini dahulu)
                if (sortOrder === 'desc') {
                    comparison *= -1;
                }
                return comparison;
            });
            // --- AKHIR LOGIK PENGASINGAN ---

            
            let html = `
                <div class="flex space-x-2 mb-4 justify-center">
                    <button onclick="displayQuizHistory('score', 'desc')" class="py-1 px-3 text-sm rounded-full ${sortBy === 'score' && sortOrder === 'desc' ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-700'} transition duration-150 shadow-sm">
                        Markah Tertinggi
                    </button>
                    <button onclick="displayQuizHistory('score', 'asc')" class="py-1 px-3 text-sm rounded-full ${sortBy === 'score' && sortOrder === 'asc' ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-700'} transition duration-150 shadow-sm">
                        Markah Terendah
                    </button>
                    <button onclick="displayQuizHistory('date', 'desc')" class="py-1 px-3 text-sm rounded-full ${sortBy === 'date' ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-700'} transition duration-150 shadow-sm">
                        Terkini
                    </button>
                </div>
                <div class="space-y-3">
            `;
            
            history.forEach((record) => {
                const bgClass = (record.tp >= 5) ? 'bg-yellow-100 border-yellow-500' : 'bg-gray-100 border-gray-300';
                const textColor = (record.tp >= 5) ? 'text-yellow-800' : 'text-gray-700';
                
                html += `
                    <div class="p-3 rounded-lg border-2 ${bgClass} shadow-sm">
                        <p class="text-xs font-bold ${textColor} mb-1 flex justify-between items-center">
                            <span>TP${record.tp}: ${record.label}</span>
                            <span class="font-normal">${record.date} ${record.time} (${record.totalTime})</span>
                        </p>
                        <p class="text-lg font-extrabold ${textColor}">
                            Markah: 
                            <span class="float-right text-lg font-extrabold">${record.score} / 50</span>
                        </p>
                    </div>
                `;
            });
            
            html += '</div>';
            historyContainer.innerHTML = html;
        }

        // --- INISIALISASI ---

        document.addEventListener('DOMContentLoaded', () => {
            initSifirSelection();
            showScreen('selection-screen');

            // Tetapkan nilai nama pelajar jika sudah ada dalam localStorage
            const storedName = localStorage.getItem('studentName');
            if (storedName) {
                document.getElementById('student-name').value = storedName;
            }
        });

    </script>
</body>

</html>
